!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).fspSDK=t()}(this,(function(){"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function t(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?e(Object(o),!0).forEach((function(e){r(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,l(o.key),o)}}function i(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(e,t,n){return(t=l(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){if(e){if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function u(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=a(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,r=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw r}}}}function l(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function h(e){var t,n=[],o=u(e);try{for(o.s();!(t=o.n()).done;){var i=t.value;i instanceof HTMLElement&&f(i)&&n.push(i)}}catch(e){o.e(e)}finally{o.f()}return n}function f(e){return 0===e.children.length}function d(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(!e.classList.contains(n))if(f(e))t.add(e);else{var o,i=n?":not(.".concat(n,", .").concat(n," *)"):"*";try{o=h(e.querySelectorAll(i))}catch(t){o=O(h(e.querySelectorAll(":not(.".concat(n,")"))),".".concat(n," *"))}!function(e,t){var n,o=u(t);try{for(o.s();!(n=o.n()).done;){var i=n.value;e.add(i)}}catch(e){o.e(e)}finally{o.f()}}(t,o)}}function v(e){return e.src.includes("/pwa_dist")}var _=null;function p(){if(null!==_)return _;var e=new URL(location.href).searchParams.get("__best_shein_debug__"),t="__is_debug__";if(e)window.sessionStorage.setItem(t,e),_="true"===e;else{var n=window.sessionStorage.getItem(t);_="true"===n}return _}function m(e){var t=window.performance;t&&p()&&t.mark(e)}function y(e,t,n){var o=window.performance;o&&p()&&(t&&n?(o.measure(e,t,n),o.clearMarks(t),o.clearMarks(n)):o.measure(e))}function b(e){var t=window.sessionStorage.getItem(e);return t?JSON.parse(t):[]}function g(e,t){var n=b(e);n.push(t),n.sort((function(e,t){return t-e}));var o=n.slice(0,10);window.sessionStorage.setItem(e,JSON.stringify(o))}function k(e){return 0===e.length?0:Math.round(e.reduce((function(e,t){return e+t}),0)/e.length)}function w(){var e;if(p()){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];(e=console).log.apply(e,["%c".concat("[fsp debug info]"),"background: #222; color: #bada55"].concat(n))}}function O(e,t){return s(e).filter((function(e){return!e.matches(t)}))}var S={},I=Symbol("defaultId"),E=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:I;if(n(this,e),r(this,"id",void 0),r(this,"events",void 0),S[t])return S[t];S[t]=this,this.id=t,this.events={}}return i(e,[{key:"on",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=this.events[e],i={callback:t,once:n};o?o.push(i):this.events[e]=[i]}},{key:"once",value:function(e,t){this.on(e,t,!0)}},{key:"off",value:function(e,t){if(t){var n=this.events[e];n&&(this.events[e]=n.filter((function(e){return e.callback!==t})))}else delete this.events[e]}},{key:"offAll",value:function(){this.events={}}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.events[e];if(n){var o,i=u(n);try{for(i.s();!(o=i.n()).done;){o.value.callback(t)}}catch(e){i.e(e)}finally{i.f()}this.events[e]=n.filter((function(e){return!e.once}))}}},{key:"destroy",value:function(){this.offAll(),delete S[this.id]}}],[{key:"destroyAll",value:function(){for(var e=0,t=Object.values(S);e<t.length;e++){t[e].offAll()}S={}}}]),e}(),C="__fsp_mo_overhead_performance__",L="__fsp_mo_callback_performance__",P="fsp-element",T="not-fsp-element",j=function(){function e(t){n(this,e),r(this,"_ee",void 0),r(this,"_options",void 0),r(this,"_mo",void 0),r(this,"_io",void 0),this._ee=new E("fsp"),this._options=t,this._init()}return i(e,[{key:"updateOptions",value:function(e){this._options.mode=e.mode||this._options.mode,this._options.ignoreClasses=e.ignoreClasses||this._options.ignoreClasses,this._options.container=e.container||this._options.container}},{key:"observe",value:function(){var e=this;m("fsp-observe-overhead-start");var t=performance.now();this._ee.emit("recordStart");var n=this._options,o=n.container,i=n.ignoreClasses;this._ee.emit("recordEnd",o),this._mo=new MutationObserver((function(t){m("fsp-mutation-observer-callback-start");var n,o=performance.now(),r=u(t);try{for(r.s();!(n=r.n()).done;){var s=n.value;if("childList"===s.type){var a,c=new Set,l=[],h=u(s.addedNodes);try{var f=function(){var e=a.value;if(e instanceof HTMLElement){var t=e.classList.toString().split(/\s+/).every((function(e){return!i.includes(e)})),n=["script","style","meta","link","head"].every((function(t){return e.tagName.toLowerCase()!==t}));t&&n&&l.push(e)}};for(h.s();!(a=h.n()).done;)f()}catch(e){h.e(e)}finally{h.f()}if(0===l.length)continue;e._io||(e._io=new IntersectionObserver((function(t){var n,o=u(t);try{for(o.s();!(n=o.n()).done;){var i=n.value,r=i.boundingClientRect,s=r.width>=1&&r.height>=1,a=i.target;a instanceof HTMLElement&&i.intersectionRatio>0&&s&&(e._ee.emit("recordEnd",a),"IMG"===a.tagName&&e._observeImage(a),e._observeBackgroundImage(a))}}catch(e){o.e(e)}finally{o.f()}})));for(var v=0,_=l;v<_.length;v++){var p=_[v];if("manual"===e._options.mode){if(p.closest(".".concat(T)))continue;if(p.closest(P))d(p,c,T);else{var b=void 0;try{b=p.querySelectorAll(".".concat(P,":not(.").concat(T," .").concat(P,")"))}catch(e){b=O(p.querySelectorAll(".".concat(P)),".".concat(T," .").concat(P))}var g,k=u(b);try{for(k.s();!(g=k.n()).done;){d(g.value,c,T)}}catch(e){k.e(e)}finally{k.f()}}}else d(p,c)}var w,S=u(c);try{for(S.s();!(w=S.n()).done;){var I=w.value;e._io.observe(I)}}catch(e){S.e(e)}finally{S.f()}}}}catch(e){r.e(e)}finally{r.f()}var E=performance.now(),C=Math.round(E-o);e._ee.emit("moPerformance",C),m("fsp-mutation-observer-callback-end"),y("fsp-mutation-observer-callback","fsp-mutation-observer-callback-start","fsp-mutation-observer-callback-end")})),this._mo.observe(o,{childList:!0,subtree:!0});var r=performance.now(),s=Math.round(r-t);this._ee.emit("overheadPerformance",s),m("fsp-observe-overhead-end"),y("fsp-observe-overhead","fsp-observe-overhead-start","fsp-observe-overhead-end")}},{key:"cleanup",value:function(){this._mo&&this._mo.disconnect(),this._io&&this._io.disconnect(),this._init()}},{key:"_init",value:function(){this._mo=null,this._io=null}},{key:"_observeImage",value:function(e){var t=this;if(!e.complete||v(e)){e.addEventListener("load",(function n(){v(e)||(t._ee.emit("recordEnd",e),e.removeEventListener("load",n))}))}}},{key:"_observeBackgroundImage",value:function(e){e.getAttribute("data-background-image")?this._observeBackgroundImageLazyLoad(e):this._observeBackgroundImageNormal(e)}},{key:"_observeBackgroundImageLazyLoad",value:function(e){var t=this,n=new MutationObserver((function(o){var i,r=u(o);try{for(r.s();!(i=r.n()).done;){var s=i.value;if("attributes"===s.type){var a=s.attributeName||"";"true"===s.target.getAttribute(a)&&(t._ee.emit("recordEnd",e),n.disconnect())}}}catch(e){r.e(e)}finally{r.f()}}));n.observe(e,{attributes:!0,attributeFilter:["loaded","data-loaded"]})}},{key:"_observeBackgroundImageNormal",value:function(e){var t=function(e){var t,n=/url\(['"]?(.+?)['"]?\)/,o=e.style.backgroundImage||e.style.background;if(n.test(o)){var i=o.match(n);t=Array.isArray(i)&&i[1]?i[1]:""}else t="";return t}(e);if(t){var n=new Image;n.src=t,this._observeImage(n)}}}]),e}(),R=function(){function e(t){n(this,e),r(this,"_ee",void 0),r(this,"_options",void 0),r(this,"_timer",void 0),r(this,"_removeEventsCallback",void 0),this._ee=new E("fsp"),this._options=t,this._init()}return i(e,[{key:"updateOptions",value:function(e){this._options.timeout=e.timeout||this._options.timeout}},{key:"waitForTerminate",value:function(){this._onTimeout(),this._onUserInteraction()}},{key:"cleanup",value:function(){this._timer&&clearTimeout(this._timer),this._removeEventsCallback&&this._removeEventsCallback(),this._init()}},{key:"_init",value:function(){this._timer=0,this._removeEventsCallback=null}},{key:"_onTimeout",value:function(){var e=this;this._timer=setTimeout((function(){e._emitTerminate({type:"timeout",payload:null})}),this._options.timeout)}},{key:"_onUserInteraction",value:function(){for(var e=this,t=["click","touchstart","keydown","wheel"],n=function(t){t.isTrusted&&e._emitTerminate({type:"user interaction: "+t.type,payload:t})},o={once:!0,capture:!0},i=0,r=t;i<r.length;i++){var s=r[i];document.addEventListener(s,n,o)}this._removeEventsCallback=function(){for(var e=0,i=t;e<i.length;e++){var r=i[e];document.removeEventListener(r,n,o)}}}},{key:"_emitTerminate",value:function(e){this._ee.emit("terminate",e)}}]),e}(),A=function(){function e(){n(this,e),r(this,"_start",void 0),r(this,"_end",void 0),r(this,"_endElement",void 0),this._init()}return i(e,[{key:"recordStart",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=performance.timeOrigin;this._start=e?t:t+performance.now(),w("record start: ".concat(e?"ssr-landing":"spa-route-change"))}},{key:"recordEnd",value:function(e){if(this._end=performance.timeOrigin+performance.now(),this._endElement=e,p()){var t=this.calculateFsp(),n=t.time,o=t.element;w("record point: ".concat(n,"ms;"),o)}}},{key:"calculateFsp",value:function(){return{time:Math.round(this._end-this._start),element:this._endElement}}},{key:"cleanup",value:function(){this._init()}},{key:"_init",value:function(){this._start=0,this._end=0,this._endElement=null}}]),e}(),D=function(){function e(t){n(this,e),r(this,"_options",void 0),r(this,"_resource",void 0),r(this,"_time",void 0),r(this,"_element",void 0),r(this,"_terminateReason",void 0),r(this,"_cache",void 0),this._options=t,this._cache={},this._init()}return i(e,[{key:"updateOptions",value:function(e){this._options.mode=e.mode||this._options.mode,this._options.container=e.container||this._options.container,this._options.isDebug=e.isDebug||this._options.isDebug,this._options.thresholdUpper=e.thresholdUpper||this._options.thresholdUpper,this._options.thresholdLower=e.thresholdLower||this._options.thresholdLower,this._options.reporterHandler=e.reporterHandler||this._options.reporterHandler,"function"==typeof this._options.reporterHandler&&this._flushCache()}},{key:"report",value:function(e){var t=this._options,n=t.thresholdLower,o=t.thresholdUpper;if(this._setReportData(e),this._time<=n)w("fsp 时间 ".concat(this._time,"ms 小于等于配置的最小临界值 ").concat(n,"ms (可能是 keep-alive 的路由来回切换), 忽略掉不上报"));else if(this._time>=o)w("fsp 时间 ".concat(this._time,"ms 大于等于配置的最大临界值 ").concat(o,"ms (时间太长有异常), 忽略掉不上报"));else if(this._element){var i=this._isFspElement(this._element);if(i.bool){this._options.isDebug&&this._reportConsole();var r={name:"fsp",value:this._time,payload:{element:this._element,resource:this._resource,terminateReason:this._terminateReason}};this._doReport(r)}else w("fsp 落点元素不是一个合法的 fsp-element: ".concat(i.reason,", 忽略掉不上报"),this._element)}else w("没有记录到 fsp 落点元素, 存在异常, 忽略掉不上报")}},{key:"reportPerformance",value:function(e,t){var n={name:e,value:t};this._doReport(n)}},{key:"cleanup",value:function(){this._init()}},{key:"_init",value:function(){this._resource="",this._time=0,this._element=null,this._terminateReason=null}},{key:"_doReport",value:function(e){"function"==typeof this._options.reporterHandler?(this._flushCache(),this._options.reporterHandler(e)):this._setCache(e)}},{key:"_setReportData",value:function(e){this._resource=e.resource,this._time=e.time,this._element=e.element,this._terminateReason=e.terminateReason}},{key:"_setCache",value:function(e){var t="".concat(e.name,"-").concat(e.value,"-").concat(Date.now());this._cache[t]=e}},{key:"_flushCache",value:function(){var e=this,t=this._cache;this._cache={},Object.keys(t).forEach((function(n){var o=t[n];"function"==typeof e._options.reporterHandler&&e._options.reporterHandler(o)}))}},{key:"_isFspElement",value:function(e){var t="manual"===this._options.mode;return e===this._options.container?{bool:!0,reason:"落在了容器上, 说明页面在 ssr 之后, ".concat(t?"fsp-element 节点没有变化; 或者页面中没有 fsp-element 节点":"节点没有变化")}:f(e)?t?e.closest(".".concat(T))?{bool:!1,reason:"元素带有 ".concat(T," 类名标记, 或者是带有该标记元素的后代元素")}:e.closest(".".concat(P))?{bool:!0,reason:"fsp 落点元素正常"}:{bool:!1,reason:"元素没有 ".concat(P," 类名标记, 或者不是带有该标记元素的后代元素")}:{bool:!0,reason:"fsp 落点元素正常"}:{bool:!1,reason:"元素不是叶子节点"}}},{key:"_reportConsole",value:function(){var e,t;w("======== record end ========"),w("resource: ".concat(this._resource)),w("time: ".concat(this._time,"ms")),w("reason: ".concat(null===(e=this._terminateReason)||void 0===e?void 0:e.type)),w("reason payload: ",null===(t=this._terminateReason)||void 0===t?void 0:t.payload),w("element: ",this._element),w("======== record end ========")}}]),e}(),F=function(){function e(t){n(this,e),r(this,"_options",void 0),r(this,"_ee",void 0),r(this,"_observer",void 0),r(this,"_terminator",void 0),r(this,"_recorder",void 0),r(this,"_reporter",void 0),r(this,"_isInitialFsp",void 0),r(this,"_terminated",void 0),r(this,"_sessionDict",void 0),r(this,"VERSION","1.0.0"),this._init(t),this._isInitialFsp=!0,this._terminated=!0,this._sessionDict={},window.sessionStorage.removeItem(C),window.sessionStorage.removeItem(L)}return i(e,[{key:"start",value:function(){return this._bindEvents(),this._observeLandingPage(),this}},{key:"updateOptions",value:function(e){var t=this;this._terminated?this._updateOptions(e):this._ee.once("terminate",(function(){t._updateOptions(e)}))}},{key:"observeRouteChange",value:function(e){var t=this;e&&e.beforeEach((function(e,n,o){var i=e.name+":"+n.name;t._sessionDict[i]>=t._options.sceneSampleCount||(t._setIsNotInitialFsp(),t._ee.emit("terminate",{type:"routeChange",payload:null}),t._observer.observe(),t._sessionDict[i]=(t._sessionDict[i]||0)+1),o()}))}},{key:"onFsp",value:function(e){this._terminated?e():this._ee.once("terminate",e)}},{key:"_init",value:function(e){this._options=this._normalizeOptions(e),this._ee=new E("fsp"),this._observer=new j({container:this._options.container,ignoreClasses:this._options.ignoreClasses,mode:this._options.mode}),this._terminator=new R({timeout:this._options.timeout}),this._recorder=new A,this._reporter=new D({mode:this._options.mode,container:this._options.container,thresholdLower:this._options.thresholdLower,thresholdUpper:this._options.thresholdUpper,isDebug:this._options.isDebug,reporterHandler:this._options.reporterHandler})}},{key:"_updateOptions",value:function(e){this._options=this._normalizeOptions(e),this._observer.updateOptions(this._options),this._terminator.updateOptions(this._options),this._reporter.updateOptions(this._options)}},{key:"_getReportResource",value:function(){return this._isInitialFsp?"ssr-landing-page":"spa-route-change"}},{key:"_observeLandingPage",value:function(){this._observer.observe()}},{key:"_bindEvents",value:function(){var e=this;this._ee.on("recordStart",(function(){e._setNotTerminated(),e._terminator.waitForTerminate(),e._recorder.recordStart(e._isInitialFsp)})),this._ee.on("recordEnd",(function(t){e._recorder.recordEnd(t)})),this._ee.on("terminate",(function(n){if(!e._terminated){e._setTerminated();var o=t(t({},e._recorder.calculateFsp()),{},{resource:e._getReportResource(),terminateReason:n});e._reporter.report(o),e._cleanup()}})),this._ee.on("overheadPerformance",(function(e){g(C,e)})),this._ee.on("moPerformance",(function(e){g(L,e)})),document.addEventListener("visibilitychange",(function(){if("hidden"===document.visibilityState){var t=k(b(C)),n=k(b(L));e._reporter.reportPerformance("fsp_mo_overhead_time",t),e._reporter.reportPerformance("fsp_mo_callback_time",n),window.sessionStorage.removeItem(C),window.sessionStorage.removeItem(L)}}))}},{key:"_normalizeOptions",value:function(e){var t,n,o,i,r,s,a,c,u,l=e;return l||(l={}),{container:l.container||(null===(t=this._options)||void 0===t?void 0:t.container)||document.documentElement,ignoreClasses:l.ignoreClasses||(null===(n=this._options)||void 0===n?void 0:n.ignoreClasses)||[],timeout:l.timeout||(null===(o=this._options)||void 0===o?void 0:o.timeout)||1e4,thresholdLower:l.thresholdLower||(null===(i=this._options)||void 0===i?void 0:i.thresholdLower)||100,thresholdUpper:l.thresholdUpper||(null===(r=this._options)||void 0===r?void 0:r.thresholdUpper)||15e3,sceneSampleCount:l.sceneSampleCount||(null===(s=this._options)||void 0===s?void 0:s.sceneSampleCount)||5,isDebug:l.isDebug||(null===(a=this._options)||void 0===a?void 0:a.isDebug)||p(),mode:l.mode||(null===(c=this._options)||void 0===c?void 0:c.mode)||"auto",reporterHandler:l.reporterHandler||(null===(u=this._options)||void 0===u?void 0:u.reporterHandler)||null}}},{key:"_setIsNotInitialFsp",value:function(){this._isInitialFsp=!1}},{key:"_setTerminated",value:function(){this._terminated=!0}},{key:"_setNotTerminated",value:function(){this._terminated=!1}},{key:"_cleanup",value:function(){this._observer.cleanup(),this._terminator.cleanup(),this._recorder.cleanup(),this._reporter.cleanup()}}]),e}();return function(){var e=new F(window.__FSP_OPTIONS__);return e.start(),e}()}));
var $jscomp={scope:{},findInternal:function(a,c,e){a instanceof String&&(a=String(a));for(var h=a.length,g=0;g<h;g++){var k=a[g];if(c.call(e,k,g,a))return{i:g,v:k}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,e){if(e.get||e.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=e.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,e,h){if(c){e=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var g=a[h];g in e||(e[g]={});e=e[g]}a=a[a.length-1];h=e[a];c=c(h);c!=h&&null!=c&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,e){return $jscomp.findInternal(this,a,e).v}},"es6-impl","es3");var ria_chat={};
(function(){function a(b){var a=GLOBAL&&GLOBAL.gmt?" ["+GLOBAL.gmt+"]":"";return moment(b).calendar(null,{sameDay:"LT"+a,lastDay:"["+GLOBAL.locale.chat.yesterday+"]"+(a?"":", LT"),lastWeek:"DD MMMM, hh:mm"+a,sameElse:function(b){return this.isBefore(b.startOf("year"))?"DD MMMM YYYY, hh:mm"+a:"DD MMMM, hh:mm"+a}})}function c(){ria_chat.state.last_date?$.ajax({url:ria_chat.state.getUrl,dataType:"json",beforeSend:function(){ria_chat.state.loading=!0;ria_chat.state.chat.addClass("chat-loader")},data:{article_id:ria_chat.state.article_id,
date:ria_chat.state.last_date.sec,date_usec:ria_chat.state.last_date.usec,id_exc:ria_chat.state.last_id,limit:9999}}).done(function(b){if(b.chat.messages){var a=b.emoji_chat;ria_chat.state.last_date=b.chat.last_date;ria_chat.state.last_id=b.chat.last_id;ria_chat.state.last_date||(window.dataLayer=window.dataLayer||[],dataLayer.push({event:"chat",gaEventAction:"chat_scroll",gaEventLabel:"comments_100%"}));n({banned_profiles:b.banned_profiles,data:b.chat.messages,prepend:!0});if(a&&a.length)for(var d in a)b=
a[d],q({emotions:b.emotions,sorted_emotions:b.sorted_emotions,message_id:b.object_id});p("0")}}).always(function(){ria_chat.state.loading=!1;ria_chat.state.chat.removeClass("chat-loader")}):p("0")}function e(){ria_chat.state.last_date&&$.ajax({url:ria_chat.state.getUrl,dataType:"json",beforeSend:function(){ria_chat.state.loading=!0},data:{article_id:ria_chat.state.article_id,date:ria_chat.state.last_date.sec,date_usec:ria_chat.state.last_date.usec,id_exc:ria_chat.state.last_id}}).done(function(b){if(b.chat.messages){var a=
b.emoji_chat;ria_chat.state.last_date=b.chat.last_date;ria_chat.state.last_id=b.chat.last_id;ria_chat.state.last_date||(window.dataLayer=window.dataLayer||[],dataLayer.push({event:"chat",gaEventAction:"chat_scroll",gaEventLabel:"comments_100%"}));var d=ria_chat.state.chat_lenta.data("theinScroll"),d=d.$content.height()-d.$box.height();n({banned_profiles:b.banned_profiles,data:b.chat.messages,prepend:!0});if(a&&a.length)for(var c in a){var f=a[c];q({emotions:f.emotions,sorted_emotions:f.sorted_emotions,
message_id:f.object_id})}b.chat.messages.length&&ria_chat.state.chat_lenta.trigger("scroll-down.the-in-scroll",[d,100])}}).always(function(){ria_chat.state.loading=!1})}function h(b){_.assign(ria_chat.state,{unread:ria_chat.state.unread+b.count});if(0!==ria_chat.state.unread){var a=$(".chat__alert-unread");if(!a.length){var d=ria_chat.state.alertUnreadTemplate();b.before?b.before.before(d):ria_chat.state.chat_lenta.trigger("add-content.the-in-scroll",[d]);setTimeout(function(){a=$(".chat__alert-unread");
ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"unread_trigger",position:a.position().top+1,sign:">",once:!0}]);ria_chat.state.chat_lenta.on("unread_trigger.the-in-scroll",function(b,a){g()})},200)}$("#chatScrollDownBtn").attr("count",ria_chat.state.unread)}}function g(){ria_chat.state.markAsReadTimeout&&clearTimeout(ria_chat.state.markAsReadTimeout);ria_chat.state.markAsReadTimeout=setTimeout(function(){$.ajax({url:ria_chat.state.setLastUrl,data:{room_id:ria_chat.state.article_id,
message_id:ria_chat.state.last_unread.id,date:ria_chat.state.last_unread.created.sec,usec:ria_chat.state.last_unread.created.usec}}).done(function(){ria_chat_manager.updateUnread();_.assign(ria_chat.state,{unread:0});$("#chatScrollDownBtn").removeAttr("count")})},5E3)}function k(){p("100%")}function l(){var b=$(".chat__alert-unread");b.length?p(b.position().top-ria_chat.state.chat_lenta.data("theinScroll").$box.height()+50):k();ria_chat.state.unreadWhenChatOpen=!1}function p(b){ria_chat.state.chat_lenta.trigger("scroll-to.the-in-scroll",
[b,100])}function u(b){b.preventDefault();ria_chat.state.unreadWhenChatOpen?l():k()}function v(b){b.preventDefault();c()}function m(b,a){if(b)return a=a||{},$.ajax({url:b,data:a,method:"POST"})}function w(){ria_chat.state.article_id&&("ontouchstart"in window||ria_chat.state.chat.find("form textarea").focus(),$.ajax({url:ria_chat.state.getUnreadUrl,dataType:"json",data:{article_id:ria_chat.state.article_id,limit:ria_chat.state.goto_message?1E3:20}}).done(function(b){var a=b.chat_messages,d=b.chat_unread_messages,
c=b.emoji_chat;if(a||d){a&&(_.assign(ria_chat.state,{user_id:b.user_id,last_date:a.last_date,last_id:a.last_id}),n({banned_profiles:b.banned_profiles,data:a.messages}));if(b.report_message_ids)for(var f=0;f<b.report_message_ids.length;f++)$("#message_"+b.report_message_ids[f]).addClass("m-removed").find(".chat__lenta-item-message").html(GLOBAL.locale.chat.report_send);d&&d.messages.length&&(_.assign(ria_chat.state,{last_unread:d.messages[d.messages.length-1]}),h({count:d.total}),n({banned_profiles:b.banned_profiles,
data:d.messages}));if(c&&c.length)for(f in c)b=c[f],q({emotions:b.emotions,sorted_emotions:b.sorted_emotions,message_id:b.object_id});setTimeout(function(){var b=ria_chat.state.chat_lenta.data("theinScroll");100===b.percentSizeScroller&&($("#chatScrollDownBtn").fadeOut(),0<ria_chat.state.unread&&g());0===b.percentSizeScroller&&$("#chatScrollTopBtn").fadeOut();if(100===b.percentSizeScroller||100>b.sizeScrollLine-b.pxSizeScroller)window.dataLayer=window.dataLayer||[],dataLayer.push({event:"chat",gaEventAction:"chat_scroll",
gaEventLabel:"comments_100%"})},99);setTimeout(function(){if(ria_chat.state.goto_message){var b=$("#message_"+ria_chat.state.goto_message);b.length?p(b.position().top-ria_chat.state.chat_lenta.data("theinScroll").$box.height()/2):k();ria_chat.state.goto_message=null}else l()},100);setTimeout(function(){ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"refreshed_trigger",position:100,sign:"<",move:!0,everytime:!0}]);ria_chat.state.chat_lenta.on("refreshed_trigger.the-in-scroll",
function(b,a){ria_chat.state.loading||e()})},101);setTimeout(function(){ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"hide_arrow_trigger",position:"99.9%",move:!0,everytime:!0}]);ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"show_arrow_trigger",position:"99.9%",sign:"<",move:!0,everytime:!0}]);ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"hide_arrow_top_trigger",position:"50px",sign:"<",move:!0,everytime:!0}]);
ria_chat.state.chat_lenta.trigger("add-scrolling-trigger.the-in-scroll",[{name:"show_arrow_top_trigger",position:"50px",sign:">",move:!0,everytime:!0}]);ria_chat.state.chat_lenta.on("hide_arrow_trigger.the-in-scroll",function(b,a){$("#chatScrollDownBtn").fadeOut();0<ria_chat.state.unread&&g()});ria_chat.state.chat_lenta.on("show_arrow_trigger.the-in-scroll",function(b,a){$("#chatScrollDownBtn").fadeIn()});ria_chat.state.chat_lenta.on("show_arrow_top_trigger.the-in-scroll",function(b,a){$("#chatScrollTopBtn").fadeIn()});
ria_chat.state.chat_lenta.on("hide_arrow_top_trigger.the-in-scroll",function(b,a){$("#chatScrollTopBtn").fadeOut()})},102)}}))}function n(b){for(var t="",d=b.data,c=b.prepend||!1,f=0;f<d.length;f++){d[f].time=a(1E3*d[f].ts_gmt);d[f].auth="ok"===GLOBAL.auth.status;d[f].letters=[];d[f].bg_number=0;for(var e=d[f].nickname.split(" "),l=0;2>l;l++)e[l]&&(d[f].bg_number+=e[l].length,d[f].letters.push(e[l].charAt(0)));d[f].bg_number=20<d[f].bg_number?Math.ceil(d[f].bg_number/10):d[f].bg_number;d[f].is_moderator=
!!GLOBAL.auth.moderator;d[f].user_id===ria_chat.state.user_id&&(d[f].is_my=!0);d[f].parent_comment&&d[f].parent_comment.user_id===ria_chat.state.user_id&&(d[f].parent_comment.is_my=!0);d[f].avatar&&(d[f].avatar=d[f].avatar.replace("https://cdn22.img.ria.ru/images/","").replace("https://cdn1.img.ria.ru/userpic/",""),d[f].avatar=GLOBAL.userpic+d[f].avatar);b.banned_profiles&&b.banned_profiles.length&&(d[f].is_blocked=!!b.banned_profiles.filter(function(b){return b.id===d[f].user_id}).length);t+=ria_chat.state.messageTemplate({data:d[f]})}ria_chat.state.chat_lenta.trigger("add-content.the-in-scroll",
[t,c]);for(f=0;f<d.length;f++)x($("#message_"+d[f].id))}function y(b){var a=$("#message_"+b.message_id);a.length&&(a.next(".chat__lenta-item").length?a.addClass("m-removed").find(".chat__lenta-item-message").html(GLOBAL.locale.chat.message_remove):a.slideUp("slow",function(){a.remove()}))}function q(b){var a=0,d;for(d in b.emotions)a+=parseInt(b.emotions[d]);a=ria_chat.state.messageEmojiTemplate({data:{icons:{s1:{icon:"likeFill",title:GLOBAL.locale.js_templates.emoji_1},s2:{icon:"hahaFill",title:GLOBAL.locale.js_templates.emoji_2},
s3:{icon:"wowFill",title:GLOBAL.locale.js_templates.emoji_3},s4:{icon:"sadFill",title:GLOBAL.locale.js_templates.emoji_4},s5:{icon:"angryFill",title:GLOBAL.locale.js_templates.emoji_5},s6:{icon:"dislikeFill",title:GLOBAL.locale.js_templates.emoji_6}},emotions:b.emotions,sorted_emotions:b.sorted_emotions,emotions_count:a}});d=$("#message_"+b.message_id);if(d.length){var c=d.find(".chat__lenta-item-likes");c.length?c.replaceWith(a):d.find(".chat__lenta-item-message").eq(0).append(a);d.data("emotions",
b.emotions)}}function z(b){b.preventDefault();b=$(this);var a=b.serializeArray();a[0].value&&(a.push({name:"article_id",value:ria_chat.state.article_id}),m(ria_chat.state.addUrl,a),b[0].reset(),"ontouchstart"in window||b.find("textarea").focus().trigger("keyup"),$(".chat__reply").remove())}function A(b){13!=b.which||b.shiftKey||($(this).closest("form").submit(),b.preventDefault())}function B(b){b.preventDefault();b=$(this).data("id");var a=$("#message_"+b);m(ria_chat.state.reportUrl,{article_id:ria_chat.state.article_id,
message_id:b});a.addClass("m-removed").find(".chat__lenta-item-message").html(GLOBAL.locale.chat.report_send)}function C(b){b.preventDefault();m(ria_chat.state.deleteUrl,{article_id:ria_chat.state.article_id,message_id:$(this).data("id")})}function D(b){b.preventDefault();m(ria_chat.state.deleteModeratorUrl,{article_id:ria_chat.state.article_id,message_id:$(this).data("id")})}function E(b){b=$(this);var a={article_id:GLOBAL.article.id,message_id:b.data("message_id")};m(ria_chat.state.deleteModeratorUrl,
a);b.closest(".best-comments__item").remove()}function F(b){b.preventDefault();if("ok"===GLOBAL.auth.status.toLowerCase()){b=$(this).data("id");var a=$("#message_"+b);b={id:b,user:a.find(".chat__lenta-item-name-text")[0].innerText,comment:a.find(".chat__lenta-item-message-text")[0].innerText};b=ria_chat.state.replyTemplate({data:b});ria_chat.state.chat.find(".chat__reply").remove();ria_chat.state.chat.find(".chat__input form").append(b);ria_chat.state.chat.find("form textarea").focus()}}function G(b){$(this).closest(".chat__reply").remove()}
function H(b){b.stopPropagation();b.preventDefault();ria_chat.state.emoji_loading||(b=$(this),b={article_id:ria_chat.state.article_id,message_id:b.data("id"),emotion:b.data("type")},ria_chat.state.emoji_loading=!0,m(ria_chat.state.emojiUrl,b).done(function(b){b=JSON.parse(b);"error"!==b.emoji.status&&(b=ria_chat.state.emojiPopperTemplate({data:{id:b.emoji.data.object_id,emotions:b.emoji.data.emotions}}),$(".chat__popper-emoji").html($(b).find(".emoji")))}).always(function(){ria_chat.state.emoji_loading=
!1}))}function I(b){b.stopPropagation();b.preventDefault();if(!ria_chat.state.emoji_loading){var a=$(this);b={article_id:GLOBAL.article.id,message_id:a.data("id"),emotion:a.data("type")};ria_chat.state.emoji_loading=!0;m(ria_chat.state.emojiUrl,b).done(function(b){b=JSON.parse(b);"error"!==b.emoji.status&&(b=ria_chat.state.emojiPopperTemplate({data:{id:b.emoji.data.object_id,emotions:b.emoji.data.emotions}}),a.closest(".emoji").replaceWith($(b).find(".emoji")))}).always(function(){ria_chat.state.emoji_loading=
!1})}}function J(b){b=$(this).closest(".chat");var a=b.find(".chat__input-editor"),d=$(this),c=b.find(".chat__input-admin");setTimeout(function(){d.css("height",0);var b=Math.min(72,d[0].scrollHeight);a.css("height",b);d.css("height",b);ria_chat.state.chat_lenta.css("bottom",33+b+c.outerHeight())},0)}function K(b){b.preventDefault();modalLayer.open({customTitle:GLOBAL.locale.chat.external_link_title,customContent:GLOBAL.locale.chat.external_link_body.replace(/\$1/g,$(this).attr("href"))})}function x(b){var a=
b.find(".chat__lenta-item-message-text").text().trim(),d=new RegExp("\\b(?:https?)://"+window.location.host+"/[a-z0-9-+&@#/%=~_.|]*","gi"),c=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;if(d.test(a))for(d.lastIndex=0;null!==(c=d.exec(a));){var f=c[0];$.ajax({url:f,dataType:"html"}).done(function(a){a.length&&(a=$(a),a={title:a.filter("title").text(),time:"",img:a.filter('meta[property="og:image"]').attr("content"),url:f,host:window.location.host},a=ria_chat.state.snippetTemplate({data:a}),
b.find(".chat__lenta-item-message-text").append(a))})}else c.test(a)&&(a=a.replace(c,'<a class="m-external" href="$1" target="_blank">$1</a>'),b.find(".chat__lenta-item-message-text").html(a))}function L(b){$(this).toggleClass("m-open")}function M(b){b.stopPropagation();b=$(this);var a;a=b.closest(".popper-wrapper");var d=b.data("for");$(".chat__popper-inner").remove();a=ria_chat.state[d]({data:{id:a.data("id"),user_id:a.data("user_id"),emotions:a.data("emotions")}});$("body").append(a);a=$(".chat__popper-inner");
a.length&&(new Popper(b,a,{placement:b.data("placement")||"left",modifiers:{preventOverflow:{enabled:!0,padding:0,boundariesElement:768<$(document).width()?b.closest(".the-in-scroll__content"):"window"}}}),a.fadeToggle(),$("body").one("click.chat__popper-inner",function(){$(".chat__popper-inner").remove()}))}function N(a){a=$(this).data("user_id");var b=$('.chat__lenta-item[data-user_id="'+a+'"]');$.ajax({url:"/services/chat/blacklist/add/",data:{blocked_user_id:a}}).done(function(){b.each(function(){$(this).addClass("m-blocked").find(".chat__lenta-item-message").eq(0).after('<div class="chat__lenta-item-message m-blocked">'+
GLOBAL.locale.chat.you_block+' <a class="chat__actions-unblock">'+GLOBAL.locale.chat.unblock+"</a></div>")})})}function O(a){a=$(this).closest(".chat__lenta-item").data("user_id");var b=$('.chat__lenta-item[data-user_id="'+a+'"]');$.ajax({url:"/services/chat/blacklist/remove/",data:{blocked_user_id:a}}).done(function(){b.each(function(){$(this).removeClass("m-blocked").find(".chat__lenta-item-message.m-blocked").remove()})})}var r={addUrl:"/services/chat/add/",eventUrl:"/services/chat/event/",likeUrl:"/services/chat/like/",
emojiUrl:"/services/chat/add_emoji/",getUrl:"/services/chat/get/",deleteUrl:"/services/chat/delete/",deleteModeratorUrl:"/services/chat/moderation/delete/",reportUrl:"/services/chat/report/",unreadUrl:"/services/chat/get_unread_counter/",getUnreadUrl:"/services/chat/get_unread_message/",setLastUrl:"/services/chat/set_last_message/",sockUrl:"http://docker-test1.rian.off:8008/chat",article_id:"",chat:null,sock:!1,loading:!1,unread:0};ria_chat={state:{},init:function(a){_.assign(a,{sock:ria_sock.get()});
_.assign(r,a);_.assign(this.state,r);ria_sock.on("chat_message",function(a){n({data:[a]});a.user_id===ria_chat.state.user_id?k():100===ria_chat.state.chat_lenta.data("theinScroll").percentSizeScroller?(_.assign(ria_chat.state,{last_unread:{id:a.id,created:{sec:a.date.sec,usec:a.date.usec}}}),g()):98>ria_chat.state.chat_lenta.data("theinScroll").scrollingPercentage?(_.assign(ria_chat.state,{last_unread:{id:a.id,created:{sec:a.date.sec,usec:a.date.usec}}}),h({before:$("#message_"+a.id),count:1}),ria_chat.state.unreadWhenChatOpen=
!0):98<=ria_chat.state.chat_lenta.data("theinScroll").scrollingPercentage&&(_.assign(ria_chat.state,{last_unread:{id:a.id,created:{sec:a.date.sec,usec:a.date.usec}}}),g(),k())});ria_sock.on("chat_message_delete",function(a){y(a)});ria_sock.on("chat_emoji_add",function(a){q(a)});ria_sock.on("onopen",function(){var a=ria_chat.state.article_id;a&&(ria_chat.left(),ria_chat.join(a))});ria_sock.on("user_notify",function(a){"site_user_ban"===a.subtype&&($(".chat__banned").show(),$(".chat__lenta").addClass("m-banned"),
a.count?$("#chatBannedTime").text(a.count+" "+GLOBAL.locale.id.stat.hour.genitive_plural):$("#chatBannedTime").text("\u221e"));"site_user_unban"===a.subtype&&($(".chat__form").show(),$(".chat__banned").hide(),$(".chat__lenta").removeClass("m-banned"))});return this},join:function(a){_.assign(ria_chat.state,{article_id:a});ria_sock.send({type:"chat_user_join",message:{obj_id:a}});w()},left:function(){ria_chat.state.article_id&&(ria_chat.state.sock&&ria_sock.connected&&ria_sock.send({type:"chat_user_left",
message:{obj_id:ria_chat.state.article_id}}),ria_chat.state.chat_lenta.off("refreshed_trigger.the-in-scroll"),ria_chat.state.chat_lenta.off("unread_trigger.the-in-scroll"),ria_chat.state.chat_lenta.off("show_arrow_trigger.the-in-scroll"),ria_chat.state.chat_lenta.off("show_arrow_top_trigger.the-in-scroll"),ria_chat.state.chat_lenta.off("hide_arrow_trigger.the-in-scroll"),ria_chat.state.chat_lenta.off("hide_arrow_top_trigger.the-in-scroll"),ria_chat.state.chat_lenta.trigger("clear-content.the-in-scroll"),
ria_chat.state.chat.find("form")[0].reset(),$("#chatScrollDownBtn").removeAttr("count").fadeIn(),$("#chatScrollTopBtn").fadeIn(),$(".chat__alert-unread").remove(),_.assign(ria_chat.state,r))},disconnect:function(){this.state.sock&&this.state.sock.close()},auth:function(){var a=ria_chat.state.article_id;a&&(ria_chat.left(),ria_chat.join(a));GLOBAL.user.isBanned&&($(".chat__banned").show(),$(".chat__lenta").addClass("m-banned"),GLOBAL.user.banTimeEnd?$("#chatBannedTime").text(GLOBAL.user.banTimeEnd):
$("#chatBannedTime").text("\u221e"));ria_chat.state.chat.find(".chat__auth").hide();ria_chat.state.chat.find(".chat__input").show()}};$(function(){$("#messageTemplate").length||$.ajax({async:!1,url:"/services/templates/",dataType:"html"}).done(function(a){$("body").append(a)});ria_chat.init({chat:$("#chatWrapper"),chat_lenta:$("#chatWrapper").find(".chat__lenta"),messageTemplate:_.template($("#messageTemplate").html()),replyTemplate:_.template($("#replyTemplate").html()),snippetTemplate:_.template($("#snippetTemplate").html()),
alertDownTemplate:_.template($("#alertDownTemplate").html()),alertUnreadTemplate:_.template($("#alertUnreadTemplate").html()),userbarPopperTemplate:_.template($("#userbarPopperTemplate").html()),myuserbarPopperTemplate:_.template($("#myuserbarPopperTemplate").html()),emojiPopperTemplate:_.template($("#emojiPopperTemplate").html()),messageEmojiTemplate:_.template($("#messageEmojiTemplate").html())});var a=$("body");a.on("submit",".chat__form",z);a.on("keypress",".chat__form-textarea",A);a.on("click",
".chat__actions-report",B);a.on("click",".chat__actions-delete",C);a.on("click",".chat__actions-delete-moderator",D);a.on("click",".chat__popper-emoji .emoji-item",H);a.on("click",".chat__actions-reply",F);a.on("dblclick",".chat__lenta-item-message",function(){$(this).closest(".chat__lenta-item").find(".chat__actions-reply").trigger("click")});a.on("click",".chat__reply-remove",G);a.on("click",".chat__alert-down",u);a.on("click",".chat__alert-top",v);a.on("input change paste keyup mouseup",".chat__form-textarea",
J);a.on("click",".chat a.m-external",K);a.on("click",".chat__lenta-quote",L);a.on("click",".best-comments__item-message-moderation .m-delete",E);a.on("click",".best__popper-emoji .emoji-item",I);a.on("click",".popper-btn",M);a.on("click",".chat__actions-block",N);a.on("click",".chat__actions-unblock",O)})})();
var ria_chat_manager={init:function(){this.updateTime=12E4;this.$chat=$("#widgetRChat");if(0>=this.$chat.length)return!1;this.mod={view_list:"m-view-list",no_list:"m-no-list"};this.$title=$(".widgets__r-header-one span",this.$live);this.$loader=$(".widgets__r-loader",this.$chat);this.$list=$(".widgets__r-list",this.$chat);this.$back=$(".widgets__r-header-button.m-back",this.$chat);this.checkActive();this.addEvents();this.updateUnread();this.updateRooms();$(".js__r-list-scroll").theinScroll({rtl:!!GLOBAL.rtl})},
addEvents:function(){var a=this;a.$list.on("click",".r-list__item",function(){a.toArticleRoom||(window.dataLayer=window.dataLayer||[],dataLayer.push({event:"chat",gaEventAction:"chat_click",gaEventLabel:"main"}));a.toOnline($(this))});a.$back.on("click",function(){a.toList()});$(".js__toggle-chat").on("click",function(){setTimeout(function(){a.$chat.hasClass(a.mod.view_list)&&a.$chat.is(":visible")?(a.updateRooms(),a.setNotification(Notifications.isAllChatsDisabled())):a.stopUpdateRooms()},0)});$(body).on("click",
".js__toggle-chat-article",function(){var c=$(this),e=null;c.data("article_id")?e=c.data("article_id"):GLOBAL.article&&GLOBAL.article.id&&(e=GLOBAL.article.id);a.openArticleRoom(e)});$("body").on("click",".best-comments__btn",function(){window.dataLayer=window.dataLayer||[];dataLayer.push({event:"chat",gaEventAction:"chat_open",gaEventLabel:"popular_comments"})});$("body").on("click",".article__userbar-item.m-discuss",function(){window.dataLayer=window.dataLayer||[];dataLayer.push({event:"chat",gaEventAction:"chat_open",
gaEventLabel:"main_comments"})});a.$chat.on("click","#chatNotificationOn, #chatNotificationOff",function(){a.$chat.hasClass(a.mod.view_list)?Notifications.setAllChats(Notifications.isAllChatsDisabled()?1:0):Notifications.setChatRoom(ria_chat.state.article_id,Notifications.isRoomDisabled(ria_chat.state.article_id)?1:0);$(this).hide().siblings().show()});setTimeout(function(){a.$chat.find(".r-list__wr").trigger("add-scrolling-trigger.the-in-scroll",[{name:"scroll_end",position:"99%",sign:">",down:!1,
everytime:!0,move:!0,once:!0}]);a.$chat.find(".r-list__wr").on("scroll_end.the-in-scroll",function(){window.dataLayer=window.dataLayer||[];dataLayer.push({event:"chat",gaEventAction:"chat_scroll",gaEventLabel:"main"})})},0)},checkActive:function(){this.$chat.hasClass(this.mod.view_list)||0>=this.$list.length&&this.$chat.addClass(this.mod.no_list)},toList:function(){this.$chat.addClass(this.mod.view_list);this.setNotification(Notifications.isAllChatsDisabled());ria_chat&&(ria_chat.left(),this.updateRooms())},
toOnline:function(a){this.setTitle(a.data("title"));if(a.data("url"))this.$title.on("click",function(){window.location.href=a.data("url")});GLOBAL.article&&GLOBAL.article.id===a.data("id")&&GLOBAL.article.chat_expired?$(".chat__expired").show():$(".chat__expired").hide();this.$chat.removeClass(this.mod.view_list);"object"==typeof a&&(ria_chat.join(a.data("id")),this.stopUpdateRooms(),this.setNotification(Notifications.isRoomDisabled(a.data("id"))))},setTitle:function(a){return this.$title?this.$title.html(a):
!1},setNotification:function(a){$("#chatNotificationOn").toggle(!a);$("#chatNotificationOff").toggle(a)},auth:function(){this.$chat=$("#widgetRChat");this.mod={view_list:"m-view-list",no_list:"m-no-list"};this.$chat.length&&(this.$chat.hasClass(this.mod.view_list)?this.setNotification(Notifications.isAllChatsDisabled()):this.setNotification(Notifications.isRoomDisabled(ria_chat.state.article_id)))},getRooms:function(){var a="/services/chat/get_rooms/",c=this.toArticleRoom||GLOBAL.article&&GLOBAL.article.id;
c&&(a+="?cur_room_id="+c);return $.ajax({url:a})},insertRooms:function(a){a&&this.$chat.find(".r-list, .r-list__wr").css({position:"absolute",top:"0",width:"100%",height:"100%"}).trigger("clear-content.the-in-scroll").trigger("add-content.the-in-scroll",[a,!0])},getUnread:function(){},updateUnread:function(){this.stopUpdateUnread();this.getUnread()},stopUpdateUnread:function(){this.getUnreadInterval&&clearInterval(this.getUnreadInterval)},updateRooms:function(){var a=this;a.stopUpdateRooms();a.getRooms().done(function(c){a.insertRooms(c);
"object"===typeof ria&&ria.convertDate();a.toArticleRoom&&setTimeout(function(){a.showArticleRoom(a.toArticleRoom)},0)})},stopUpdateRooms:function(){this.getRoomsInterval&&clearInterval(this.getRoomsInterval)},openArticleRoom:function(a){this.toArticleRoom=a;this.$chat.is(":visible")?this.$chat.hasClass(this.mod.view_list)?this.toArticleRoom&&this.showArticleRoom(this.toArticleRoom):this.toList():$(".js__toggle-chat").eq(0).trigger("click")},showArticleRoom:function(a){this.$list.find(".r-list__item").filter('[data-id="'+
a+'"]').trigger("click");this.toArticleRoom=!1}};$(function(){ria_chat_manager.init()});
Notifications={subscribe:[],add:function(a){$("#notificationsTemplate").length||$.ajax({async:!1,url:"/services/templates/",dataType:"html"}).done(function(a){$("body").append(a)});var c=_.template($("#notificationsTemplate").html()),e=_.template($("#notificationsChatTemplate").html()),h=_.template($("#notificationsHeaderTemplate").html()),g="",k=$("#notifications"),g="chat_new_message"===a.subtype||"chat_message_delete"===a.subtype||"chat_room_close"===a.subtype||"chat_message_like"===a.subtype||
"chat_message_answer"===a.subtype||"chat_verify_message"===a.subtype?g+e({data:a}):g+c({data:a});$(".notifications__header").length||k.append(h({}).trim());k.prepend(g.trim());(new Audio("/i/open-ended.mp3")).play()},getSubscribe:function(){return $.ajax({url:"/services/notification/subscribe/get_comet/"})},setChatRoom:function(a,c){$.ajax({url:"/services/notification/subscribe/set_comet_chat_room/",data:{room_id:a,active:c}}).done(function(){var e=Notifications.subscribe.filter(function(c){return"chat_room"===
c.type&&+c.room_id===+a})[0];e?e.is_active=c:Notifications.subscribe.push({type:"chat_room",room_id:a,is_active:c})})},setAllChats:function(a){$.ajax({url:"/services/notification/subscribe/set_comet_allchats/",data:{active:a}}).done(function(){var c=Notifications.subscribe.filter(function(a){return"all_chats"===a.type})[0];c?c.is_active=a:Notifications.subscribe.push({type:"all_chats",is_active:a})})},setAllMail:function(a){return $.ajax({url:"/services/notification/subscribe/set_mail_all/",data:{active:a}})},
isRoomDisabled:function(a){var c=Notifications.isAllChatsDisabled(),e=Notifications.subscribe.filter(function(c){return"chat_room"===c.type&&+c.room_id===+a});e.length&&1===e[0].is_active?c=!1:e.length&&0===e[0].is_active&&(c=!0);return c},isAllChatsDisabled:function(){return!!Notifications.subscribe.filter(function(a){return"all_chats"===a.type&&0===a.is_active}).length},init:function(a){this.getSubscribe().done(function(c){c=JSON?JSON.parse(c):{};c.subscribe&&(Notifications.subscribe=c.subscribe);
a&&a instanceof Function&&a()})}};GLOBAL&&GLOBAL.auth&&"ok"===GLOBAL.auth.status&&Notifications.init();
$(function(){var a=$("#notifications");a.on("click",".notifications__item-close",function(){var c=$(this).closest(".notifications__item"),e=c.data("id");c.fadeOut("fast",function(){$(this).remove();localStorage.setItem("notification_remove",e);a.find(".notifications__item").length||$(".notifications__header").fadeOut("fast",function(){$(this).remove()})})});window.onstorage=function(c){"notification_remove"===c.key&&c.newValue&&a.find(".notifications__item").filter("[data-id="+c.newValue+"]").find(".notifications__item-close").trigger("click")};
a.on("click","#notificationsHide",function(){$(".notifications__header").fadeOut("fast",function(){$(this).remove()});a.find(".notifications__item").fadeOut("fast",function(){$(this).remove()})});a.on("click","#notificationsSettingsMore",function(){a.toggleClass("m-settings-open")});a.on("click",".notifications__item-on span",function(){var a=$(this),c=a.closest(".notifications__item-on").data("room_id");a.addClass("m-hidden").siblings().removeClass("m-hidden");Notifications.setChatRoom(c,Notifications.isRoomDisabled(c)?
1:0)});a.on("change","#notificationsSettingsFormDisableAll",function(){Notifications.setAllChats($(this).is(":checked")?1:0)});a.on("click",".notifications__goto_room",function(){var a=$(this).data("room_id");ria_chat_manager.openArticleRoom(a)});a.on("click",".notifications__goto_message",function(){var a=$(this).data("room_id"),c=$(this).data("message_id");ria_chat.state.goto_message=c;ria_chat_manager.openArticleRoom(a)});ria_sock.on("user_notify",function(a){"user_notify"===a.type&&Notifications.add(a)});
if("ontouchstart"in document.documentElement){var c=$("#notifications"),e=new Hammer(c[0]),h=0,g=0,k=!1;e.get("pan").set({direction:Hammer.DIRECTION_VERTICAL,threshold:0});e.on("pan",function(a){var e;k||(k=!0,g=0,c.children().each(function(){g+=$(this).outerHeight(!0)}),h=c.outerHeight());e=h-a.deltaY;e=Math.max(e,160);e=Math.min(e,g);c.css({maxHeight:e+30});a.isFinal&&(k=!1)})}GLOBAL.events.subscribe("login",function(a){Notifications.init(function(){ria_chat_manager.auth()})})});

function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"===_typeof(r)?r:r+""}function _toPrimitive(e,r){if("object"!==_typeof(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var o=t.call(e,r||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}var Service_worker_starter=function(){function Service_worker_starter(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Service_worker_starter),_defineProperty(this,"checkForSubscription",(function(){var r=e;r.params.swRegistration.pushManager.getSubscription().then((function(e){r.params.isSubscribed=!(null===e),r.params.isSubscribed||r.subscribeUser()})).catch((function(e){console.log("Failed to check subscription: ",e)}))})),_defineProperty(this,"askPermission",(function(){var r=e;return new Promise((function(e,r){var t=Notification.requestPermission((function(r){e(r)}));t&&t.then(e,r)})).then((function(e){"granted"!==e?r.postAjax("/profile/change_enable_push_notification",{enablePushNotification:0,token:page_params.token},(function(e){})):r.checkForSubscription()}))})),_defineProperty(this,"manageServiceWorkerVersion",(function(){var r=e;if(console.log("ServiceWorker scope: ",r.params.swRegistration.scope,"   Expected version: "+r.params.swVersion),r.hasLocalStorage()){if(localStorage.getItem("sw-version")!==e.params.swVersion)try{r.params.swRegistration.update(),localStorage.setItem("sw-version",r.params.swVersion)}catch(e){console.log("Service Worker needs to be updated to new version")}}else console.log("Service Worker needs to be updated to new version")})),_defineProperty(this,"hasLocalStorage",(function(){try{localStorage.enableStorage=1,localStorage.removeItem("enableStorage")}catch(e){return!1}return!0}));this.params=_objectSpread(_objectSpread({},{isSubscribed:!1,swRegistration:null}),r),this.add_listeners()}return _createClass(Service_worker_starter,[{key:"add_listeners",value:function add_listeners(){var e=this;void 0!==page_params.holiday_promo&&page_params.holiday_promo&&"serviceWorker"in navigator?(window.addEventListener("load",(function(){navigator.serviceWorker.register(page_params.sw_starter_setup.serviceWorkerPath).then((function(r){e.params.swRegistration=r,e.manageServiceWorkerVersion(),"PushManager"in window&&page_params.user.isLoggedIn&&e.params.userEnabledNotification?(console.log("Notification Push is supported"),e.askPermission()):console.log("Push messaging is not supported")}),(function(e){console.log("ServiceWorker registration failed: ",e)}))})),window.addEventListener("appinstalled",(function(r){console.log("RedTube App Installed"),e.params.isMobile&&ga("send",{hitType:"event",eventCategory:"PWA",eventAction:"Add_to_homescreen",eventLabel:"Mobile"})}))):void 0!==page_params.holiday_promo&&page_params.holiday_promo||!("serviceWorker"in navigator)||navigator.serviceWorker.getRegistrations().then((function(e){if(e.length>0){for(var r=0;r<e.length;r++)e[r].unregister();window.location.reload(!0)}}))}},{key:"urlB64ToUint8Array",value:function urlB64ToUint8Array(e){for(var r=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(r),o=new Uint8Array(t.length),n=0;n<t.length;++n)o[n]=t.charCodeAt(n);return o}},{key:"postAjax",value:function postAjax(e,r,t){var o="string"==typeof r?r:Object.keys(r).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])})).join("&"),n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return n.open("POST",e),n.onreadystatechange=function(){n.readyState>3&&200==n.status&&t(n.responseText)},n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(o),n}},{key:"sendSubscriptionToBackEnd",value:function sendSubscriptionToBackEnd(e){return e=JSON.parse(JSON.stringify(e)),this.postAjax(this.params.sendSubscriptionUrl,{vendor_endpoint:e.endpoint,user_public_key:e.keys.p256dh,user_auth_token:e.keys.auth,token:page_params.token},(function(e){console.log(e)}))}},{key:"subscribeUser",value:function subscribeUser(){var e=this,r={userVisibleOnly:!0,applicationServerKey:e.urlB64ToUint8Array(e.params.applicationServerPublicKey)};e.params.swRegistration.pushManager.subscribe(r).then((function(r){e.sendSubscriptionToBackEnd(r),e.params.isSubscribed=!0})).catch((function(e){console.log("Failed to subscribe the user: ",e)}))}}]),Service_worker_starter}();try{var sw_starter=new Service_worker_starter(page_params.sw_starter_setup)}catch(e){if(page_params.global.isJsErrorLoggingEnabled){var xhr=new XMLHttpRequest;xhr.open("POST",page_params.global.jsErrorReportUrl),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify({data_sent:page_params.sw_starter_setup,error:e.toString(),file_name:"service_worker_starter-1.0.0_es6",function_name:"init",platform:page_params.global.platform,token:page_params.token,urlError:window.location.href,userAgent:page_params.global.userAgent,addon:!page_params.holiday_promo||!page_params.holiday_promo,isLoggedIn:page_params.user.isLoggedIn})),console.log("error in sw_starter")}}
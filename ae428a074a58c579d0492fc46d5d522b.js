/**
 * Project: Ensonhaber.com
 * Author: Caner ONCEL (@caneroncel)
 * Ensonhaber Development Team
 *
 * Version: 1.00
 * 10/17/2023, 4:32:04 AM
 */

window.config={...window.config,userApiUrl:"https://user.ensonhaber.com/"};class loginActionsClass{constructor(){this.user=localStorage.getItem("user")?JSON.parse(localStorage.getItem("user")):null,this.init(),this.getUserMenuTemplate(),this.user&&(this.user.token_expire&&this.user.token_expire<Math.floor(Date.now()/1e3)&&this.logout(),console.log(this.user.lastRefresh,Math.floor(Date.now()/1e3)-60),(!this.user.lastRefresh||this.user.lastRefresh<Math.floor(Date.now()/1e3)-60)&&this.setUser(this.user,{refreshPage:!1})),document.querySelector(".mobile-account")&&document.querySelector(".mobile-account").addEventListener("click",(e=>{this.user?window.location="/profil-ayarlar":(hideMenu(),this.loginModal())}))}init(){this.switcher="",this.remindPassData={step:"mail",user:{}},this.passwordReminderTemplate=null,this.mobileSwitcher={},this.timerWork=null,this.smscounter=null}register(){if(this.mobileSwitcher.register)return void this.loginWithSms("register");const e=document.getElementById("register"),t=new FormData(e),r=Object.fromEntries(t);return r.verifycode&&""!==r.verifycode?(loading(),void this.request({url:config.userApiUrl+"activatewithmail",method:"POST",type:"form",data:new URLSearchParams({m:r.mail,verify_code:r.verifycode})}).then((e=>{notyf.success("Kayıt başarılı."),modalDialog("hide"),loading("hide"),this.setUser(e.user)})).catch((e=>{console.log("error: ",e),notyf.error(e.error),loading("hide")}))):r.mail&&r.password&&r.password2?r.password!==r.password2?(notyf.error("Şifreler uyuşmuyor."),void e.querySelector('input[name="password"]').focus()):r.password.length<6?(notyf.error("Şifre en az 6 karakter olmalıdır."),void e.querySelector('input[name="password"]').focus()):void(r.tos?(loading(),this.request({url:config.userApiUrl+"activatewithmail",method:"POST",type:"form",data:new URLSearchParams({m:r.mail,p:r.password})}).then((t=>{e.classList.add("verification")})).catch((e=>{notyf.error(e.error)})).finally((()=>{loading("hide")}))):notyf.error("Lütfen kullanım koşullarını kabul ediniz.")):(notyf.error("Lütfen tüm alanları doldurunuz."),void e.querySelector('input[name="mail"]').focus())}login(e){if(this.mobileSwitcher.login)return void this.loginWithSms("login");e.target;const t=document.getElementById("login"),r=new FormData(t),i=Object.fromEntries(r);if(""===i.mail||!1===validMail(i.mail))return t.querySelector('input[name="mail"]').focus(),notyf.error("Lütfen geçerli bir e-posta adresi giriniz."),!1;loading(),this.request({url:config.userApiUrl+"userlogin",method:"POST",type:"form",data:new URLSearchParams({m:i.mail,p:i.password})}).then((e=>{0===e.err_code?(notyf.success("Giriş yapıldı."),modalDialog("hide"),this.setUser(e.user)):notyf.error(e.msg)})).catch((e=>{notyf.error(e.error)})).finally((()=>{loading("hide")}))}retrySMS(e){document.getElementById(e).classList.contains("verification")&&!this.timerWork&&(console.log("retrySMS"),this.loginWithSms(e))}loginWithSms(e){const t=document.getElementById(e),r=new FormData(t),i=Object.fromEntries(r);return i.gsm=i.gsm&&i.gsm.replace(/[^\d]/g,""),i.verifycode&&""!==i.verifycode?(loading(),void this.request({url:config.userApiUrl+"activatewithsms",method:"POST",type:"form",data:new URLSearchParams({num:i.gsm,verify_code:i.verifycode})}).then((e=>{notyf.success("Giriş başarılı."),modalDialog("hide"),loading("hide"),this.setUser(e.user)})).catch((e=>{console.log("error: ",e),notyf.error(e.error),loading("hide")}))):this.timerWork?void notyf.error("Lütfen 60 saniye sonra tekrar deneyiniz."):""===i.gsm?(t.querySelector('input[name="gsm"]').focus(),notyf.error("Lütfen geçerli bir telefon numarası giriniz."),!1):void("register"!==e||i.tos?(loading(),this.request({url:config.userApiUrl+"activatewithsms",method:"POST",type:"form",data:new URLSearchParams({num:i.gsm})}).then((e=>{t.classList.add("verification"),this.timer(t)})).catch((e=>{notyf.error(e.error)})).finally((()=>{loading("hide")}))):notyf.error("Lütfen kullanım koşullarını kabul ediniz."))}reminderPassword(){const e=document.querySelector("#password-modal-form"),t=new FormData(e),r=Object.fromEntries(t),i=async t=>{e.querySelectorAll(".reminder_steps").forEach((e=>e.style.display="none")),e.querySelector(".reminder_steps."+t).style.display="block",this.remindPassData.step=t};if("newpass"===this.remindPassData.step){if(""===r.verifycode)return void notyf.error("Lütfen doğrulama kodunu giriniz.");if(""===r.password||""===r.password2||r.password!==r.password2)return void notyf.error("Şifreler uyuşmuyor.");if(r.password.length<6)return void notyf.error("Şifre en az 6 karakter olmalıdır.");loading(),this.request({url:config.userApiUrl+"remindpassword",method:"POST",type:"form",data:new URLSearchParams({m:r.mail,verify_code:r.verifycode,password:r.password})}).then((e=>{notyf.success("Şifreniz başarıyla güncellendi."),modalDialog("hide")})).catch((e=>{notyf.error(e.error)})).finally((()=>{loading("hide")}))}if("mail"===this.remindPassData.step){if(""===r.mail||!1===validMail(r.mail))return e.querySelector('input[name="mail"]').focus(),notyf.error("Lütfen geçerli bir e-posta adresi giriniz."),!1;loading(),this.request({url:config.userApiUrl+"remindpassword",method:"POST",type:"form",data:new URLSearchParams({m:r.mail})}).then((e=>{notyf.success("Doğrulama kodu mail adresinize gönderildi."),i("newpass")})).catch((e=>{notyf.error(e.error)})).finally((()=>loading("hide")))}}loginWithSocial(e){let t=window.location.origin+"/loginwithsocial/"+e,r=window.open(window.config.user.host+"/activatewithsocial?application="+e+"&backurl="+t,"loginwithsocial","width=800,height=600"),i=setInterval((function(){if(r.closed){clearInterval(i);let e=localStorage.getItem("social_token")||null;e?(loading(),loginActions.setUser({token:e}).then((()=>{notyf.success("Giriş başarılı."),modalDialog("hide")})).catch((e=>{notyf.error("Bir hata oluştu tekrar deneyiniz.")})).finally((()=>{loading("hide"),localStorage.removeItem("social_token")}))):notyf.error("Kullanıcı bilgileri alınamadı, Tekrar Deneyiniz.")}}))}timer(e){const t=e.querySelector(".smstimer-selector"),r=e.querySelector(".smscountdown"),i=e.querySelector(".smsprogress"),o=config.user.login.gsm.smsretry,s=60*o;var n,a,l=s;t.classList.add("timer-start"),gsmlogin.disabled=!0,gsmregister.disabled=!0,r.textContent="0"+o+":00",this.timerWork=!0,this.smscounter=setInterval((function(){n=parseInt(l/60,10),a=parseInt(l%60,10),n=n<10?"0"+n:n,a=a<10?"0"+a:a;var e=(60*parseInt(n)+ +a)/(60*o)*100;r.textContent=n+":"+a,i.style.width=e+"%",--l<0&&(l=s,i.style.width="100%",t.classList.remove("timer-start"),gsmlogin.disabled=!1,gsmregister.disabled=!1,loginActions.resetTimer())}),1e3)}resetTimer(){console.log("reset timer"),this.timerWork&&(this.timerWork=null,clearInterval(this.smscounter),this.smscounter=null)}loginModal(e="login"){"undefined"!=typeof notyf&&notyf.dismissAll(),loading();const t=[];["/assets/plugins/imask.js","/assets/js/lib/functions/inputMask.js","/assets/js/lib/functions/validMail.js"].forEach((function(e){const r=document.createElement("script");r.src=e,r.async=!1,null==document.body.querySelector("script[src='"+e+"']")&&(document.body.appendChild(r),t.push(new Promise(((e,t)=>{r.onload=e}))))})),Promise.all(t).then((()=>{this.request({url:config.loginmodal.url,output:"resp"}).then((t=>{loading("hide"),this.init(),modalDialog("hide"),modalDialog(!1,t,"480px");const r=document.getElementById("password-modal").innerHTML;document.getElementById("password-modal").remove(),this.passwordReminderTemplate=r,inputMask(),"register"===e&&setTimeout((()=>{loginActions.switchLogin("register")}),300)})).catch((()=>notyf.error("Giriş formu getirilirken bir hata meydana geldi.")))})).catch((()=>notyf.error("Kaynaklar yüklenemedi.")))}verifiedModal(){"undefined"!=typeof notyf&&notyf.dismissAll(),loading();const e=[];["/assets/plugins/imask.js","/assets/js/lib/functions/inputMask.js","/assets/js/lib/functions/validMail.js"].forEach((function(t){const r=document.createElement("script");r.src=t,r.async=!1,null==document.body.querySelector("script[src='"+t+"']")&&(document.body.appendChild(r),e.push(new Promise(((e,t)=>{r.onload=e}))))})),Promise.all(e).then((()=>{this.request({url:config.verifiedmodal.url+"?t="+(new Date).getTime(),output:"resp"}).then((async e=>{let t=await this.request({url:"https://user.ensonhaber.com/uservalidate",method:"POST",type:"form",data:new URLSearchParams({send:1,token:this.user.token})}),r="";return t.verification.mail&&(r="e-mail adresinize"),t.verification.phone&&(r="telefon numaranıza"),e.replaceAll("{{type}}",r)})).then((e=>{loading("hide"),modalDialog("hide"),modalDialog(!1,e,"480px")})).catch((()=>{loading("hide"),modalDialog("hide"),notyf.error("Doğrulama formu getirilirken bir hata meydana geldi.")}))})).catch((()=>notyf.error("Kaynaklar yüklenemedi.")))}verifiedAccount(e){loading(),this.request({url:"https://user.ensonhaber.com/uservalidate",method:"POST",type:"form",data:new URLSearchParams({pin:e,token:this.user.token})}).then((e=>{notyf.success("Hesabınız doğrulandı."),localStorage.setItem("user",JSON.stringify({...this.user,verified:1})),setTimeout((()=>{window.location.reload()}),1e3)})).catch((e=>{notyf.error(e.err_msg)})).finally((()=>{loading("hide")}))}passwordReminderOpen(){modalDialog("Şifre Hatırlatma",this.passwordReminderTemplate,"480px"),document.querySelector('#password-modal-form input[name="mail"]').focus()}switchLogin(e){var t=document.getElementById("loginregister");if(document.querySelector(".switcher").classList.contains("disabled"))return!1;t.className="",t.classList.add("active-"+e),this.switcher=e}mobileSwitch(e){var t=document.getElementById("login"),r=document.getElementById("gsmlogin");t.classList.remove("verification"),"register"===e&&(t=document.getElementById("register"),r=document.getElementById("gsmregister")),r.checked?t.classList.add("mobile"):t.classList.remove("mobile"),this.mobileSwitcher[e]=r.checked}setUser(e,t={}){if(void 0===t.refreshPage&&(t.refreshPage=1),e.token)return new Promise(((r,i)=>{this.request({url:"/auth",method:"POST",type:"form",data:new URLSearchParams({token:e.token,fcm_token:sessionStorage.getItem("firebaseToken")?sessionStorage.getItem("firebaseToken"):null})}).then((e=>{let i=e.user;i={...i,lastRefresh:Math.floor(Date.now()/1e3)},localStorage.setItem("user",JSON.stringify(i)),this.user=i,this.getUserMenuTemplate(),t.refreshPage&&1===t.refreshPage&&(window.parent.postMessage({loginSuccess:!0},"*"),setTimeout((()=>{window.location.reload()}),500)),r(i)})).catch((e=>{notyf.error(e.error),i(e)}))}));window.location.href="/"}logout(e=!0){this.user&&(e&&!confirm("Çıkış yapmak istediğinize emin misiniz?")||(loading(),this.request({url:"/auth",method:"POST",type:"form",data:new URLSearchParams({logout:1})}).then((e=>{localStorage.removeItem("user"),this.user=null,this.getUserMenuTemplate(),e.refresh&&1===e.refresh&&location.reload()})).catch((e=>{notyf.error(e.error)})).finally((()=>loading("hide")))))}request(e={}){return new Promise(((t,r)=>{const i=new XMLHttpRequest;e.url=e.url+"?_="+(new Date).getTime(),i.open(e.method||"GET",e.url,!0),"form"===e.type?i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","application/json"),i.onload=function(){(this.status<200||this.status>=400)&&r({error:"Bağlantı hatası."});const i=this.response;if("resp"!==e.output)try{const e=JSON.parse(i);0!==parseInt(e.err_code)&&r({error:e.msg}),t(e)}catch(e){r({error:"Beklenmedik bir hata oluştu."})}else t(i)},i.onerror=function(){r({error:"Bağlantı hatası."})},i.send("form"===e.type?e.data:JSON.stringify(e.data))}))}getUserMenuTemplate(e){if(this.user&&this.user.id){const e=this.user;let t=e.name||"Hesabınız";0===e.verified&&(t=`<font color="red">! ${t}</font>`);const r=`\n                <a href="javascript:;" class="profile">\n                    <span><img src="${""!=e.picture?e.picture:"/assets/img/nav/user.svg"}" alt="" /></span>\n                    ${t}\n                </a>\n                \n                <div class="submenu">\n                    <ul>\n                        ${0===e.verified?'<li><a href="javascript:loginActions.verifiedModal();">Hesabınızı Onaylayın</a></li>':""}\n                        ${0!==e.verified?`\n                        <li><a href="/u/${e.username}"><i class="icon-person"></i> Profiliniz</a></li>\n                        <li><a href="/profil-ayarlar"><i class="icon-settings"></i> Ayarlar</a></li>\n                        ${e.premium?"":'<li><a href="/profil-ayarlar#reklamsiz-surum"><i class="icon-layers-clear"></i> Reklamsız Sürüm</a></li>'}\n                        <li><a href="/iletisim"><i class="icon-chat"></i> Geri Bildirim</a></li>\n                        <li class="border-top"><a href="javascript:;" onclick="loginActions.logout()"><i class="icon-power"></i> Çıkış</a></li>\n                        `:""}\n                    </ul>\n                </div>\n            `;document.querySelector(".mobile-account")&&(document.querySelector(".mobile-account").innerHTML=`<span><img loading="lazy" src="${""!=e.picture?e.picture:"/assets/img/nav/user.svg"}" alt="" /></span>`),document.getElementById("top-user-menu")&&(document.getElementById("top-user-menu").innerHTML=r,document.getElementById("top-user-menu").classList.add("dropdown"))}else{const e='<a href="javascript:;" class="hint-bottom-middle user" data-hint="Giriş & Kayıt" onclick="loginActions.loginModal();">Üyelik</a>';document.querySelector(".mobile-account")&&(document.querySelector(".mobile-account").innerHTML=' <i class="icon-account-circle"></i>'),document.getElementById("top-user-menu")&&(document.getElementById("top-user-menu").innerHTML=e,document.getElementById("top-user-menu").classList.remove("dropdown"))}}googleLoginCallback(e){let t=window.config.user.host+"/api/v2/activatewithsocialapp/google";if(e.credential){let r=new FormData;r.append("token",e.credential),loading(),fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(r)}).then((e=>e.json())).then((e=>{0===e.err_code?loginActions.setUser({token:e.user.token}).then((()=>{notyf.success("Giriş başarılı.")})).catch((e=>{notyf.error("Bir hata oluştu tekrar deneyiniz.")})).finally((()=>{loading("hide")})):(notyf.error(e.msg),loading("hide"))})).catch((e=>{notyf.error("Bir hata oluştu tekrar deneyiniz."),loading("hide")}))}}}const loginActions=new loginActionsClass;window.onload=function(){if(loginActions.user&&loginActions.user.id)return;google.accounts.id.initialize({client_id:window.config.tparty.google_client_id,callback:loginActions.googleLoginCallback});const e=document.getElementById("google_login_button");google.accounts.id.renderButton(e,{theme:"default"})};
require=function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";module.exports={assert:require("./assert"),count:require("./count"),countReset:require("./countReset"),dir:require("./dir"),dirxml:require("./dirxml"),enabled:require("./enabled"),error:require("./error"),group:require("./group"),groupCollapsed:require("./groupCollapsed"),groupEnd:require("./groupEnd"),info:require("./info"),log:require("./log"),profile:require("./profile"),profileEnd:require("./profileEnd"),table:require("./table"),time:require("./time"),timeEnd:require("./timeEnd"),trace:require("./trace"),warn:require("./warn")}},{"./assert":2,"./count":3,"./countReset":4,"./dir":5,"./dirxml":6,"./enabled":7,"./error":8,"./group":9,"./groupCollapsed":10,"./groupEnd":11,"./info":12,"./log":14,"./profile":15,"./profileEnd":16,"./table":17,"./time":18,"./timeEnd":19,"./trace":20,"./warn":21}],2:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("assert")},{"./internal/expose":13}],3:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("count")},{"./internal/expose":13}],4:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("countReset")},{"./internal/expose":13}],5:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("dir")},{"./internal/expose":13}],6:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("dirxml")},{"./internal/expose":13}],7:[function(require,module,exports){"use strict";var DEBUG_MESSAGING_KEY="f7c9180f-5c45-47b4-8de4-428015f096c0",enabled=!1,_window={};"undefined"!=typeof window&&(_window=window||self);try{enabled=!!_window.localStorage.getItem(DEBUG_MESSAGING_KEY)}catch(e){}module.exports=enabled},{}],8:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("error")},{"./internal/expose":13}],9:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("group")},{"./internal/expose":13}],10:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("groupCollapsed")},{"./internal/expose":13}],11:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("groupEnd")},{"./internal/expose":13}],12:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("info")},{"./internal/expose":13}],13:[function(require,module,exports){"use strict";var enabled=require("../enabled");module.exports=function(e){return function(){if(enabled&&"object"==typeof window.console&&"function"==typeof console[e])return console[e].apply(console,Array.prototype.slice.call(arguments,0))}}},{"../enabled":7}],14:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("log")},{"./internal/expose":13}],15:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("profile")},{"./internal/expose":13}],16:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("profileEnd")},{"./internal/expose":13}],17:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("table")},{"./internal/expose":13}],18:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("time")},{"./internal/expose":13}],19:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("timeEnd")},{"./internal/expose":13}],20:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("trace")},{"./internal/expose":13}],21:[function(require,module,exports){"use strict";module.exports=require("./internal/expose")("warn")},{"./internal/expose":13}],22:[function(require,module,exports){"use strict";module.exports={browser:{safari:!1,chrome:!1,firefox:!1,ie:!1,opera:!1,android:!1,edge:!1,edgeChromium:!1,samsung:!1,version:{string:"",major:0,minor:0,patch:0,documentMode:!1}},os:{osx:!1,ios:!1,android:!1,windows:!1,linux:!1,fireos:!1,chromeos:!1,version:{string:"",major:0,minor:0,patch:0}}}},{}],23:[function(require,module,exports){"use strict";module.exports={browser:[{name:"edge",userAgent:"Edge",version:["rv","Edge"],test:function(e){return e.ua.indexOf("Edge")>-1||"Mozilla/5.0 (Windows NT 10.0; Win64; x64)"===e.ua}},{name:"edgeChromium",userAgent:"Edge",version:["rv","Edg"],test:function(e){return e.ua.indexOf("Edg")>-1&&-1===e.ua.indexOf("Edge")}},{name:"chrome",userAgent:"Chrome"},{name:"firefox",test:function(e){return e.ua.indexOf("Firefox")>-1&&-1===e.ua.indexOf("Opera")},version:"Firefox"},{name:"android",userAgent:"Android"},{name:"safari",test:function(e){return e.ua.indexOf("Safari")>-1&&e.vendor.indexOf("Apple")>-1},version:"Version"},{name:"ie",test:function(e){return e.ua.indexOf("IE")>-1||e.ua.indexOf("Trident")>-1},version:["MSIE","rv"],parseDocumentMode:function(){var e=!1;return document.documentMode&&(e=parseInt(document.documentMode,10)),e}},{name:"opera",userAgent:"Opera",version:["Version","Opera"]},{name:"samsung",userAgent:"SamsungBrowser"}],os:[{name:"windows",test:function(e){return e.ua.indexOf("Windows")>-1},version:"Windows NT"},{name:"osx",userAgent:"Mac",test:function(e){return e.ua.indexOf("Macintosh")>-1}},{name:"ios",test:function(e){return e.ua.indexOf("iPhone")>-1||e.ua.indexOf("iPad")>-1},version:["iPhone OS","CPU OS"]},{name:"linux",userAgent:"Linux",test:function(e){return(e.ua.indexOf("Linux")>-1||e.platform.indexOf("Linux")>-1)&&-1===e.ua.indexOf("Android")}},{name:"fireos",test:function(e){return e.ua.indexOf("Firefox")>-1&&e.ua.indexOf("Mobile")>-1},version:"rv"},{name:"android",userAgent:"Android",test:function(e){return e.ua.indexOf("Android")>-1}},{name:"chromeos",userAgent:"CrOS"}]}},{}],24:[function(require,module,exports){"use strict";var defaults=require("./defaults"),dictionary=require("./dictionary");function _matchVersionStrRegExp(e){return new RegExp(e+"[a-zA-Z\\s/:]+([0-9_.]+)","i")}function _parseVersion(e,r){if("function"==typeof e.parseVersion)return e.parseVersion(r);var n=e.version||e.userAgent;"string"==typeof n&&(n=[n]);for(var t,s=n.length,o=0;o<s;o++)if((t=r.match(_matchVersionStrRegExp(n[o])))&&t.length>1)return t[1].replace(/_/g,".");return!1}function _parseUserAgent(e,r,n){for(var t,s,o=e.length,i=0;i<o;i++)if("function"==typeof e[i].test?!0===e[i].test(n)&&(t=e[i].name):n.ua.indexOf(e[i].userAgent)>-1&&(t=e[i].name),t){if(r[t]=!0,"string"==typeof(s=_parseVersion(e[i],n.ua))){var a=s.split(".");r.version.string=s,a&&a.length>0&&(r.version.major=parseInt(a[0]||0),r.version.minor=parseInt(a[1]||0),r.version.patch=parseInt(a[2]||0))}else"edge"===t&&(r.version.string="12.0.0",r.version.major="12",r.version.minor="0",r.version.patch="0");return"function"==typeof e[i].parseDocumentMode&&(r.version.documentMode=e[i].parseDocumentMode()),r}return r}function parseUserAgent(e){var r={};return r.browser=_parseUserAgent(dictionary.browser,defaults.browser,e),r.os=_parseUserAgent(dictionary.os,defaults.os,e),r}module.exports=parseUserAgent},{"./defaults":22,"./dictionary":23}],25:[function(require,module,exports){"use strict";var navigatorObj={ua:window.navigator.userAgent,platform:window.navigator.platform,vendor:window.navigator.vendor};module.exports=require("./parseUserAgent")(navigatorObj)},{"./parseUserAgent":24}],26:[function(require,module,exports){!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Okapi=t():e.Okapi=t()}(this,function(){return function(){var e={61:function(e,t,r){var o=r(698).default;function n(){"use strict";e.exports=n=function(){return t},e.exports.__esModule=!0,e.exports.default=e.exports;var t={},r=Object.prototype,i=r.hasOwnProperty,a=Object.defineProperty||function(e,t,r){e[t]=r.value},s="function"==typeof Symbol?Symbol:{},c=s.iterator||"@@iterator",l=s.asyncIterator||"@@asyncIterator",g=s.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function h(e,t,r,o){var n=t&&t.prototype instanceof f?t:f,i=Object.create(n.prototype),s=new A(o||[]);return a(i,"_invoke",{value:k(e,r,s)}),i}function p(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var m={};function f(){}function d(){}function y(){}var v={};u(v,c,function(){return this});var b=Object.getPrototypeOf,S=b&&b(b(P([])));S&&S!==r&&i.call(S,c)&&(v=S);var w=y.prototype=f.prototype=Object.create(v);function _(e){["next","throw","return"].forEach(function(t){u(e,t,function(e){return this._invoke(t,e)})})}function O(e,t){function r(n,a,s,c){var l=p(e[n],e,a);if("throw"!==l.type){var g=l.arg,u=g.value;return u&&"object"==o(u)&&i.call(u,"__await")?t.resolve(u.__await).then(function(e){r("next",e,s,c)},function(e){r("throw",e,s,c)}):t.resolve(u).then(function(e){g.value=e,s(g)},function(e){return r("throw",e,s,c)})}c(l.arg)}var n;a(this,"_invoke",{value:function(e,o){function i(){return new t(function(t,n){r(e,o,t,n)})}return n=n?n.then(i,i):i()}})}function k(e,t,r){var o="suspendedStart";return function(n,i){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===n)throw i;return{value:void 0,done:!0}}for(r.method=n,r.arg=i;;){var a=r.delegate;if(a){var s=j(a,r);if(s){if(s===m)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===o)throw o="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o="executing";var c=p(e,t,r);if("normal"===c.type){if(o=r.done?"completed":"suspendedYield",c.arg===m)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o="completed",r.method="throw",r.arg=c.arg)}}}function j(e,t){var r=t.method,o=e.iterator[r];if(void 0===o)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,j(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var n=p(o,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,m;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,m):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,m)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function P(e){if(e){var t=e[c];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:I}}function I(){return{value:void 0,done:!0}}return d.prototype=y,a(w,"constructor",{value:y,configurable:!0}),a(y,"constructor",{value:d,configurable:!0}),d.displayName=u(y,g,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,u(e,g,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},_(O.prototype),u(O.prototype,l,function(){return this}),t.AsyncIterator=O,t.async=function(e,r,o,n,i){void 0===i&&(i=Promise);var a=new O(h(e,r,o,n),i);return t.isGeneratorFunction(r)?a:a.next().then(function(e){return e.done?e.value:a.next()})},_(w),u(w,g,"Generator"),u(w,c,function(){return this}),u(w,"toString",function(){return"[object Generator]"}),t.keys=function(e){var t=Object(e),r=[];for(var o in t)r.push(o);return r.reverse(),function e(){for(;r.length;){var o=r.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=P,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,o){return a.type="throw",a.arg=e,t.next=r,o&&(t.method="next",t.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var n=this.tryEntries[o],a=n.completion;if("root"===n.tryLoc)return r("end");if(n.tryLoc<=this.prev){var s=i.call(n,"catchLoc"),c=i.call(n,"finallyLoc");if(s&&c){if(this.prev<n.catchLoc)return r(n.catchLoc,!0);if(this.prev<n.finallyLoc)return r(n.finallyLoc)}else if(s){if(this.prev<n.catchLoc)return r(n.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return r(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var o=r.completion;if("throw"===o.type){var n=o.arg;x(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:P(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),m}},t}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports},698:function(e){function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},687:function(e,t,r){var o=r(61)();e.exports=o;try{regeneratorRuntime=o}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=o:Function("r","regeneratorRuntime = r")(o)}}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,r),i.exports}r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,{a:t}),t},r.d=function(e,t){for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function n(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,r){if(e){if("string"==typeof e)return t(e,r);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?t(e,r):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t,r,o,n,i,a){try{var s=e[i](a),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(o,n)}function a(e){return function(){var t=this,r=arguments;return new Promise(function(o,n){var a=e.apply(t,r);function s(e){i(a,o,n,s,c,"next",e)}function c(e){i(a,o,n,s,c,"throw",e)}s(void 0)})}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var n=o.call(t,"string");if("object"!==e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===e(r)?r:String(r)}function l(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,c(o.key),o)}}function g(e,t,r){return t&&l(e.prototype,t),r&&l(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}r.r(o),r.d(o,{default:function(){return x}});var u=r(687),h=r.n(u);function p(e,t,r){return(t=c(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var m=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"DEFAULT";s(this,t),this.namespace=e,this.shouldLog=!1}return g(t,[{key:"_checkLogStatus",value:function(){var t=new URL(window.location.href),r="object"===e(t.searchParams)&&Boolean(null!==t.searchParams.get("log")||"yup"===t.searchParams.get("showOkapiLogs"));this.shouldLog=r}},{key:"log",value:function(){var e;this._checkLogStatus();for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];this.shouldLog&&(e=console).log.apply(e,["".concat(this.namespace.toUpperCase(),":")].concat(r))}}]),t}(),f=new m("Utils"),d=function(){function t(){s(this,t)}return g(t,null,[{key:"flattenObject",value:function(t){return function t(r,o,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a={},s=o;return void 0!==n&&""!==n&&(s=i?"".concat(n,"[").concat(o,"]"):"".concat(n,".").concat(o)),"object"!==e(r)?(a[s]=r,a):(Object.keys(r).forEach(function(e){var o=Array.isArray(r),n=t(r[e],e,s,o);a=function(e){var t={};return e.forEach(function(e){Object.keys(e).forEach(function(r){t[r]=e[r]})}),t}([a,n])}),a)}(t)}},{key:"unFlattenObject",value:function(t){var r={};return"object"!==e(t)||Array.isArray(t)||null===t||0===Object.keys(t).length&&t.constructor===Object?t:(Object.keys(t).forEach(function(e){for(var o=e.length,n=r,i="",a=0;a<o;){var s=e.charAt(a);if("["===s){var c=a+1,l=e.indexOf("]",c);n[i]=n[i]||[],n=n[i],i=e.slice(c,l),a=l+1}else{var g,u="."===s?a+1:a,h=e.indexOf("[",u),p=e.indexOf(".",u);n[i]=n[i]||{},n=n[i],g=a=h<0&&p<0?o:h<0?p:p<0||h<p?h:p,i=e.slice(u,g)}}n[i]=t[e]}),r[""])}},{key:"validateArguments",value:function(t){for(var r,o=null,n=!0,i=0;n&&i<t.length;)"string"==typeof t[i].type&&e(t[i].argument)!==t[i].type||Array.isArray(t[i].type)&&!t[i].type.includes(e(t[i].argument))?"array"===t[i].type&&Array.isArray(t[i].argument)?(r="".concat(t[i].name," is a valid argument."),i++):(n=!1,r="".concat(t[i].name," is not a valid argument. Value: ").concat(t[i].argument),o=new Error(r)):(r="".concat(t[i].name," is a valid argument."),i++),f.log(r);return{isArgumentsValid:n,argumentsError:o}}},{key:"trackMetricsResultMapping",value:function(e,t){return Array.isArray(t)?t.reduce(function(t,r,o){var n=e[o],i={userId:n.userId,projectSlug:n.projectSlug,testSlug:n.testSlug,metricSlug:n.metricSlug,result:r};return t.push(i),t},[]):[]}}]),t}();function y(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}var v=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,t);var r=new m("Config");r.log("Initializing config");var o={"endpoints.timeout":{value:3e3,allowOverwrite:!0,type:"number"},"endpoints.retries":{value:0,allowOverwrite:!0,type:"number"},"endpoints.retryDelay":{value:0,allowOverwrite:!0,type:"number"},"endpoints.basePath":{value:"https://okapi-services-uat.apple.com/api/v3/okapi",allowOverwrite:!0,type:"string"},"endpoints.getOrAllocatePath":{value:"/getOrAllocate",allowOverwrite:!0,type:"string"},"endpoints.trackMetricsPath":{value:"/track",allowOverwrite:!0,type:"string"},"endpoints.forceAllocatePath":{value:"/forceAllocate",allowOverwrite:!0,type:"string"},"endpoints.allocateAndTrackPath":{value:"/allocateAndTrack",allowOverwrite:!0,type:"string"},"endpoints.triggerPath":{value:"/trigger",allowOverwrite:!0,type:"string"},"endpoints.allocateAndTriggerPath":{value:"/allocateAndTrigger",allowOverwrite:!0,type:"string"},"cache.duration":{value:"VISIT",allowOverwrite:!0,type:["string","number"],validator:function(e){return"number"==typeof e||["VISIT","SESSION"].includes(e)}},"cache.size":{value:100,allowOverwrite:!0,type:"number"},"batch.metricsBatching":{value:!0,allowOverwrite:!0,type:"boolean"},"batch.metricsBatchingInterval":{value:3e3,allowOverwrite:!0,type:"number"},"batch.batchingInterruptionEvents":{value:["blur","pagehide","visibilitychangeHidden","unload"],allowOverwrite:!0,type:"array"},_getValues:function(){var e=this,t={};return Object.keys(this).filter(function(e){return"_getValues"!==e}).forEach(function(r){t[r]=e[r].value}),t}};r.log("Client config",e);var n=d.flattenObject(e);r.log("Flattened client config",n),r.log("Default config",o._getValues());var i=this.constructor._merge(n,o,r);this.config=Object.freeze(i._getValues()),r.log("Final config",this.config)}return g(t,null,[{key:"_merge",value:function(t,r,o){var n=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?y(Object(r),!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({},r);return Object.keys(t).forEach(function(i){var a,s,c;if(i.startsWith("_")||void 0===r[i])o.log("".concat(i," is not a valid config prop."));else if(!0===r[i].allowOverwrite)if(a=t[i],s=r[i].type,c=function(t,r){return"array"===r?Array.isArray(t):e(t)===r},"string"==typeof s?c(a,s):Array.isArray(s)&&s.some(function(e){return c(a,e)})){if("function"==typeof r[i].validator&&!r[i].validator(t[i]))return void o.log("".concat(i," config prop has not passed custom property validation check. Validator: ").concat(r[i].validator,"."));if(function(t,r){return"object"===e(t)?JSON.stringify(t)===JSON.stringify(r):"function"!=typeof t&&t===r}(t[i],r[i].value))o.log("".concat(i," config prop value is the same as current config value."));else{if("function"==typeof r[i].modifier){var l=r[i].modifier(t[i]);o.log("".concat(i," user config prop value has been modified by modifier. New value: ").concat(l,". Old value: ").concat(n[i],".")),t[i]=l}o.log("".concat(i," config prop value has been updated. New value: ").concat(t[i],". Old value: ").concat(r[i].value,".")),n[i].value=t[i]}}else o.log("".concat(i," config prop has invalid type. Allowed types: ").concat(r[i].type,"."));else o.log("".concat(i," config prop is read-only."),r[i])}),n}}]),t}();function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var w=function(){function t(r){if(s(this,t),this.logger=new m("Cache"),this.logger.log("Initializing cache"),this.storagePrefix="okapi",this.storeKey="".concat(this.storagePrefix,"store"),this.orderKey="".concat(this.storagePrefix,"order"),this.cacheSize=r["cache.size"],this.cacheDuration=r["cache.duration"],this.store={},this.order=[],this.logger.log("Cache size",this.cacheSize),this.logger.log("Cache duration",this.cacheDuration),this.logger.log("Cache store key",this.storeKey),this.logger.log("Cache order key",this.orderKey),"SESSION"===this.cacheDuration){this.logger.log("Getting cache form session storage:");try{this.store=JSON.parse(sessionStorage.getItem(this.storeKey)),this.logger.log("Read store:",JSON.parse(JSON.stringify(this.store))),null!==this.store&&"object"===e(this.store)||(this.logger.log("Store is not an object, converting to empty object."),this.store={},this.logger.log("Cache store state:",JSON.parse(JSON.stringify(this.store)))),this.order=JSON.parse(sessionStorage.getItem(this.orderKey)),this.logger.log("Read order:",JSON.parse(JSON.stringify(this.order))),Array.isArray(this.order)||(this.logger.log("Order is not an array, converting to empty array."),this.order=[],this.logger.log("Cache order state:",JSON.parse(JSON.stringify(this.order)))),this._clearLocalStorage()}catch(e){this.logger.log("Unable to read cache from session storage",e)}}else if("number"==typeof this.cacheDuration){this.logger.log("Getting cache form local storage:");try{this.store=JSON.parse(localStorage.getItem(this.storeKey)),this.logger.log("Read store:",JSON.parse(JSON.stringify(this.store))),null!==this.store&&"object"===e(this.store)||(this.logger.log("Store is not an object, converting to empty object."),this.store={},this.logger.log("Cache store state:",JSON.parse(JSON.stringify(this.store)))),this.order=JSON.parse(localStorage.getItem(this.orderKey)),this.logger.log("Read order:",JSON.parse(JSON.stringify(this.order))),Array.isArray(this.order)||(this.logger.log("Order is not an array, converting to empty array."),this.order=[],this.logger.log("Cache order state:",JSON.parse(JSON.stringify(this.order)))),this._clearSessionStorage()}catch(e){this.logger.log("Unable to read cache from local storage",e)}}else this._clearLocalStorage(),this._clearSessionStorage();this.logger.log("Cache is ready"),this.logger.log("Initial cache",this.store),this.logger.log("Initial cache order",this.order)}return g(t,[{key:"_clearSessionStorage",value:function(){this.logger.log("Cleaning session storage:");try{sessionStorage.removeItem(this.storeKey),sessionStorage.removeItem(this.orderKey),this.logger.log("Session storage cleared.")}catch(e){this.logger.log("Unable to clean session storage",e)}}},{key:"_clearLocalStorage",value:function(){this.logger.log("Cleaning local storage:");try{localStorage.removeItem(this.storeKey),localStorage.removeItem(this.orderKey),this.logger.log("Local storage cleared.")}catch(e){this.logger.log("Unable to clean local storage",e)}}},{key:"_remove",value:function(e){this.logger.log("Removing item from the cache. Hash:",e),delete this.store[e];var t=this.order.indexOf(e);this.order.splice(t,1),this.logger.log("Item removed")}},{key:"get",value:function(e,t,r){this.logger.log("Get cached item called. UserId: ".concat(e,". ProjectSlug: ").concat(t,". TestSlug: ").concat(r,"."));var o=this.constructor._getHash(e,t,r);this.logger.log("Hash:",o);var n=this.store[o];if(!n)return this.logger.log("Item not found in the cache.",n),null;if(this.logger.log("Item found in the cache.",n),"never"===n.expirationTime)return n.data;var i=(new Date).getTime();return n.expirationTime>i?n.data:(this.logger.log("Item expired. Expiration time: ".concat(n.expirationTime,". Now: ").concat(i,".")),delete this.store[o],this.order.splice(this.order.indexOf(o),1),this.logger.log("Item removed from the cache."),null)}},{key:"set",value:function(e,t,r,o){this.logger.log("Set item called. UserId: ".concat(e,". ProjectSlug: ").concat(t,". TestSlug: ").concat(r,"."));var i=this.constructor._getHash(e,t,r);this.logger.log("Hash:",i);var a="never";if("number"==typeof this.cacheDuration&&(a=(new Date).getTime()+this.cacheDuration),this.order.length>=this.cacheSize){this.logger.log("Cache is full. Cache size: ".concat(this.order.length,".")),this.logger.log("Cache state:",S({},this.store)),this.logger.log("Order state:",n(this.order)),this.logger.log("Removing oldest item:");var s=this.order[0];this.logger.log("Item to remove hash:",s),this._remove(s),this.logger.log("Cache state:",S({},this.store)),this.logger.log("Order state:",n(this.order))}var c={data:o,expirationTime:a};if(this.logger.log("Adding item to the cache:",c),this.order.includes(i)&&(this.logger.log("Item is already cached."),this.logger.log("Cache state:",S({},this.store)),this.logger.log("Order state:",n(this.order)),this._remove(i),this.logger.log("Cache state:",S({},this.store)),this.logger.log("Order state:",n(this.order))),this.store[i]=c,this.order.push(i),this.logger.log("Item added to the cache."),this.logger.log("Cache state:",S({},this.store)),"SESSION"===this.cacheDuration){this.logger.log("Updating cache and cache order in session storage:");try{sessionStorage.setItem(this.storeKey,JSON.stringify(this.store)),sessionStorage.setItem(this.orderKey,JSON.stringify(this.order)),this.logger.log("Session storage updated."),this.logger.log("Session storage store:",sessionStorage.getItem(this.storeKey)),this.logger.log("Session storage order:",sessionStorage.getItem(this.orderKey))}catch(e){this.logger.log("Unable to write cache to session storage:",e)}}else if("number"==typeof this.cacheDuration){this.logger.log("Updating cache and cache order in local storage:");try{localStorage.setItem(this.storeKey,JSON.stringify(this.store)),localStorage.setItem(this.orderKey,JSON.stringify(this.order)),this.logger.log("Local storage updated."),this.logger.log("Local storage store:",localStorage.getItem(this.storeKey)),this.logger.log("Local storage order:",localStorage.getItem(this.orderKey))}catch(e){this.logger.log("Unable to write cache to local storage:",e)}}}}],[{key:"_getHash",value:function(e,t,r){return"".concat(e,"-").concat(t,"-").concat(r)}}]),t}();function _(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function O(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?_(Object(r),!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):_(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var k=function(){function e(t){s(this,e),this.logger=new m("api"),this.logger.log("Initializing APIs:"),this.config=t,this.logger.log("APIs initialized."),this.errors=Object.freeze({internal:Error("Internal Error"),timeout:Error("Timeout"),notFound:Error("Endpoint not found"),unauthorized:Error("Unauthorized"),invalid:Error("Invalid Client Request")}),this._storeLock=!1}var t,r,o,i,c,l;return g(e,[{key:"post",value:function(e,t){var r=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this.logger.log("Ajax call. URL: ".concat(e,". \n      Try number: ").concat(i,".\n      Data:"),t),new Promise(function(a,s){var c=function(c){var l;r.logger.log("Retrying. Try number: ".concat(i,". Max num of retries: ").concat(r.config["endpoints.retries"],".")),i<r.config["endpoints.retries"]?l=setTimeout(function(){a(r.post(e,t,o,n,++i))},r.config["endpoints.retryDelay"]):(r.logger.log("Maximum number of retries reached."),clearTimeout(l),s(c))},l=function(e){return O(O(O(O(O(O(O({},e.error&&{error:e.error}),e.exceptionMessage&&{exceptionMessage:e.exceptionMessage}),e.exceptionStack&&{exceptionStack:e.exceptionStack}),e.errorMessage&&{errorMessage:e.errorMessage}),e.violations&&{violations:e.violations}),e.stack&&{stack:e.stack}),e.code&&{code:e.code})},g=new XMLHttpRequest;g.open("POST",e),g.timeout=r.config["endpoints.timeout"],function(e){return!e||0===Object.keys(e).length&&e.constructor===Object}(o)?(r.logger.log("No custom headers, using simple request."),g.setRequestHeader("Content-Type","text/plain")):(r.logger.log("Using custom headers, use application/json."),r.logger.log("headers",o),Object.keys(o).filter(function(e){return!["content-type","cache-control"].includes(e.toLowerCase())}).forEach(function(e){g.setRequestHeader(e,o[e])}),g.setRequestHeader("Content-Type","application/json"),g.setRequestHeader("Cache-Control","no-cache")),g.onload=function(){if(g.status>=200&&g.status<300)if(r.logger.log("Success response received:",g.response),n)try{r.logger.log("Parsing response:");var e=JSON.parse(g.response);r.logger.log("Parsed:",e),a(e)}catch(e){r.logger.log("Unable to parse response.",e),s(r.errors.internal)}else a();else try{r.logger.log("Error response received:",g.response);var t=JSON.parse(g.response);c(l(t))}catch(e){r.logger.log("Unable to parse response.",e),404===g.status?(r.logger.log("Not found response received:",g.response),c(r.errors.notFound)):401===g.status?(r.logger.log("Unauthorized response received:",g.response),a(r.errors.unauthorized)):400===g.status||403===g.status?(r.logger.log("Invalid Client Request:",g.response),c(r.errors.invalid)):(r.logger.log("Unauthorized response received:",g.response),c(r.errors.internal))}},g.onerror=function(){try{r.logger.log("Error received:",g.response);var e=JSON.parse(g.response);c(l(e))}catch(e){r.logger.log("Unable to parse response.",e),c(r.errors.internal)}},g.ontimeout=function(){r.logger.log("Timeout."),c(r.errors.timeout)},g.send(JSON.stringify(t))})}},{key:"add",value:function(e){var t;(t=this._metricStore).push.apply(t,n(e))}},{key:"getOrAllocate",value:(l=a(h().mark(function e(t,r,o,n,i,a){var s,c,l;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.getOrAllocatePath"]),c={userId:t,projectSlug:r,testSlug:o,publicToken:n,payload:i},this.logger.log('Calling "getOrAllocate" API.\n      URL: '.concat(s,". \n      Data:"),c),e.prev=3,e.next=6,this.post(s,c,a);case 6:return l=e.sent,this.logger.log('"getOrAllocate" response received:',l),e.abrupt("return",l);case 11:throw e.prev=11,e.t0=e.catch(3),this.logger.log('"getOrAllocate" error occur:',e.t0),e.t0;case 15:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,t,r,o,n,i){return l.apply(this,arguments)})},{key:"forceAllocate",value:(c=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.forceAllocatePath"],"/").concat(encodeURI(i)),l={userId:t,projectSlug:r,testSlug:o,publicToken:n,payload:a},this.logger.log('Calling "forceAllocate" API. \n      URL: '.concat(c,". \n      Data:"),l),e.prev=3,e.next=6,this.post(c,l,s);case 6:return g=e.sent,this.logger.log('"forceAllocate" response received:',g),e.abrupt("return",g);case 11:throw e.prev=11,e.t0=e.catch(3),e.t0;case 14:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,t,r,o,n,i,a){return c.apply(this,arguments)})},{key:"trackMetrics",value:(i=a(h().mark(function e(t,r){var o,n,i;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.trackMetricsPath"]),n=t,this.logger.log('Calling "trackMetrics" API. \n      URL: '.concat(o,". \n      Data:"),n),e.prev=3,this._storeLock=!0,this.logger.log("lock the store"),e.next=8,this.post(o,n,r);case 8:return i=e.sent,this.logger.log('"trackMetrics" response received.'),e.abrupt("return",i);case 13:throw e.prev=13,e.t0=e.catch(3),e.t0;case 16:case"end":return e.stop()}},e,this,[[3,13]])})),function(e,t){return i.apply(this,arguments)})},{key:"allocateAndTrack",value:(o=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.allocateAndTrackPath"]),l={userId:t,projectSlug:r,testSlug:o,publicToken:n,payload:i,metrics:a},this.logger.log('Calling "allocateAndTrack" API. \n      URL: '.concat(c,". \n      Data:"),l),e.prev=3,e.next=6,this.post(c,l,s);case 6:return g=e.sent,this.logger.log('"allocateAndTrack" response received.'),e.abrupt("return",g);case 11:throw e.prev=11,e.t0=e.catch(3),e.t0;case 14:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,t,r,n,i,a,s){return o.apply(this,arguments)})},{key:"trigger",value:(r=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.triggerPath"]),l={userId:t,projectSlug:r,testSlug:o,publicToken:n,eventTime:i,userMetadata:a},this.logger.log('Calling "trigger" API. \n      URL: '.concat(c,". \n      Data:"),l),e.prev=3,e.next=6,this.post(c,l,s);case 6:return g=e.sent,this.logger.log('"trigger" response received.'),e.abrupt("return",g);case 11:throw e.prev=11,e.t0=e.catch(3),e.t0;case 14:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,t,o,n,i,a,s){return r.apply(this,arguments)})},{key:"allocateAndTrigger",value:(t=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c="".concat(this.config["endpoints.basePath"]).concat(this.config["endpoints.allocateAndTriggerPath"]),l={userId:t,projectSlug:r,testSlug:o,publicToken:n,payload:i,metrics:a},this.logger.log('Calling "allocateAndTrack" \n      API. URL: '.concat(c,". \n      Data:"),l),e.prev=3,e.next=6,this.post(c,l,s);case 6:return g=e.sent,this.logger.log('"allocateAndTrack" response received.'),e.abrupt("return",g);case 11:throw e.prev=11,e.t0=e.catch(3),e.t0;case 14:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,r,o,n,i,a,s){return t.apply(this,arguments)})}]),e}(),j=new m("Main");function T(e){var t=e;return e&&e.variations&&Array.isArray(e.variations)?t=e.variations.map(function(e){return{metaData:d.unFlattenObject(e.metaData),variation:e.variation}}):(console.warn("Invalid or null response!",e),j.log("Invalid or null response!")),j.log("Variation Data:",t),j.log("Caching response:"),t}var x=function(){function t(e){s(this,t),this.logger=j,this.logger.log("Initializing Okapi JS Thin Client."),this.config=new v(e),this.cache=new w(this.config.config),this.api=new k(this.config.config),this._metricStore=[],this._metricTempStore=[],this._timer=null,this._tempTimer=null,this._timerStore=[],this._timerTempStore=[],this._promiseStore=[],this._promiseTempStore=[],this.init()}var r,o,i,c,l,u,p;return g(t,[{key:"init",value:function(){var e=this,t=this.config.config["batch.metricsBatching"],r=this.config.config["batch.batchingInterruptionEvents"];["DOMContentLoaded","load","focus","blur","unload","pagehide","visibilitychange"].forEach(function(o){if("visibilitychange"!==o)t&&r.includes(o)&&(e.logger.log("".concat(o," event triggered")),e.forceTrackMetrics());else{var n=r.includes("visibilitychangeVisible"),i=r.includes("visibilitychangeHidden");window.addEventListener(o,function(){("visible"===document.visibilityState&&n||"hidden"===document.visibilityState&&i)&&(e.logger.log("".concat(o," ").concat(document.visibilityState," event triggered")),e.forceTrackMetrics())})}})}},{key:"timeout",value:function(e,t,r){var o=this,n=null;return{promise:new Promise(function(i,s){n=setTimeout(a(h().mark(function e(){var n;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{n=o.api.trackMetrics(t,r),i(n)}catch(e){s(e)}case 1:case"end":return e.stop()}},e)})),e)}),timer:n,cancel:function(){clearTimeout(n)}}}},{key:"clearMetricStore",value:function(e){for(var t=0;t<e;t++)this._metricStore.shift()}},{key:"getOrAllocate",value:(p=a(h().mark(function e(t,r,o,n,i,a){var s,c,l,g,u,p,m;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.log("getOrAllocate method called."),this.logger.log('Validating "getOrAllocate" arguments.'),s=d.validateArguments([{argument:t,name:"userId",type:["number","string"]},{argument:r,name:"projectSlug",type:"string"},{argument:o,name:"testSlug",type:"string"},{argument:n,name:"publicToken",type:"string"},{argument:i,name:"payload",type:["null","undefined","object"]},{argument:a,name:"headers",type:["object","undefined"]}]),c=s.isArgumentsValid,l=s.argumentsError,c){e.next=5;break}throw l;case 5:if(this.logger.log('All "arguments" are valid.'),this.logger.log("Checking cache:"),!(g=this.cache.get(t,r,o))){e.next=11;break}return this.logger.log("Cached value:",g),e.abrupt("return",g);case 11:return u=null,i&&(this.logger.log("Generating map from the user data object."),u=d.flattenObject(i),this.logger.log("User data map is generated:",u)),e.prev=13,this.logger.log('\n\n\nCalling "getOrAllocate" API.'),e.next=17,this.api.getOrAllocate(t,r,o,n,u,a);case 17:return p=e.sent,this.logger.log('"getOrAllocate" response received:',p),m=T(p),this.cache.set(t,r,o,m),this.logger.log("Response cached.\n\n\n"),e.abrupt("return",m);case 25:throw e.prev=25,e.t0=e.catch(13),e.t0;case 28:case"end":return e.stop()}},e,this,[[13,25]])})),function(e,t,r,o,n,i){return p.apply(this,arguments)})},{key:"forceAllocate",value:(u=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g,u,p,m;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.log('Validating "forceAllocate" arguments.'),c=d.validateArguments([{argument:t,name:"userId",type:["number","string"]},{argument:r,name:"projectSlug",type:"string"},{argument:o,name:"testSlug",type:"string"},{argument:n,name:"publicToken",type:"string"},{argument:i,name:"variationName",type:"string"},{argument:a,name:"payload",type:["null","undefined","object"]},{argument:s,name:"headers",type:["object","undefined"]}]),l=c.isArgumentsValid,g=c.argumentsError,l){e.next=4;break}throw g;case 4:return this.logger.log('All "arguments" are valid.'),u=null,a&&(this.logger.log("Generating map from the user data object."),u=d.flattenObject(a),this.logger.log("User data map is generated:",u)),e.prev=7,this.logger.log('Calling "forceAllocate" API.'),e.next=11,this.api.forceAllocate(t,r,o,n,i,u,s);case 11:return p=e.sent,this.logger.log('"forceAllocate" response received:',p),m=T(p),this.cache.set(t,r,o,m),this.logger.log("Response cached.\n\n\n"),e.abrupt("return",m);case 19:throw e.prev=19,e.t0=e.catch(7),e.t0;case 22:case"end":return e.stop()}},e,this,[[7,19]])})),function(e,t,r,o,n,i,a){return u.apply(this,arguments)})},{key:"promiseRecursive",value:function(){var e=this;Promise.resolve().then(function t(){return e.api._storeLock?null:e._timer?e._timer.promise.then(function(t){return e.logger.log("Resolve each promise in promise store after receiving batching request response",n(e._promiseStore)),e._promiseStore.forEach(function(e){var r=e.startIndex,o=e.endIndex,n=t.slice(r,o);e.promise.resolve(n),e.promiseState="fulfilled"}),e._metricStore=[],e._promiseStore=[],e._timer=null,e.logger.log("clear metricStore",e._metricStore.length,"clear promiseStore",e._promiseStore.length),e._tempTimer&&(e.logger.log("move temp store to main store"),e._metricStore=e._metricTempStore,e._promiseStore=e._promiseTempStore,e._timerStore=e._timerTempStore,e._timer=e._tempTimer,e._metricTempStore=[],e._promiseTempStore=[],e._timerTempStore=[],e._tempTimer=null,e.logger.log("metricStore",e._metricStore,"promiseStore",e._promiseStore,"timer",e._timer)),e.api._storeLock=!1,e.logger.log("release lock"),null},function(t){return e.logger.log("Reject each promise in promise store after receiving batching request fail response",n(e._promiseStore)),e._promiseStore.forEach(function(e){e.promise.reject(t),e.promiseState="rejected"}),e._metricStore=[],e._promiseStore=[],e.logger.log("clear metricStore",e._metricStore.length,"clear promiseStore",e._promiseStore.length),e.logger.log("release lock"),e._tempTimer&&(e.logger.log("move temp store to main store"),e._metricStore=e._metricTempStore,e._promiseStore=e._promiseTempStore,e._timerStore=e._timerTempStore,e._timer=e._tempTimer,e._metricTempStore=[],e._promiseTempStore=[],e._timerTempStore=[],e._tempTimer=null,e.logger.log("metricStore",e._metricStore,"promiseStore",e._promiseStore,"timer",e._timer)),e.api._storeLock=!1,e.logger.log("release lock"),null}).then(t):null}).catch(function(e){throw e})}},{key:"trackMetrics",value:(l=a(h().mark(function e(t,r){var o,i,a,s,c,l,g,u,p,m=this;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.log('Validating "trackMetrics" arguments.'),o=d.validateArguments([{argument:t,name:"metrics",type:"array"}]),i=o.isArgumentsValid,a=o.argumentsError,i){e.next=4;break}throw a;case 4:if(t.forEach(function(e){var t=d.validateArguments([{argument:e.userId,name:"userId",type:["number","string"]},{argument:e.projectSlug,name:"projectSlug",type:"string"},{argument:e.testSlug,name:"testSlug",type:"string"},{argument:e.publicToken,name:"publicToken",type:"string"},{argument:e.metricSlug,name:"metricSlug",type:"string"},{argument:e.metricValue,name:"metricValue",type:"number"},{argument:e.payload,name:"payload",type:["null","undefined","object"]},{argument:e.eventTime,name:"eventTime",type:["undefined","number"]}]);if(i=t.isArgumentsValid,a=t.argumentsError,!i)throw a}),s=d.validateArguments([{argument:r,name:"headers",type:["object","undefined"]}]),i=s.isArgumentsValid,a=s.argumentsError,i){e.next=10;break}throw a;case 10:if(this.logger.log('All "arguments" are valid.'),t.forEach(function(e){e.payload&&(m.logger.log("Generating map from the metric data object."),e.userMetadata=d.flattenObject(e.payload),delete e.payload,m.logger.log("Metric data map is generated:",e.userMetadata))}),e.prev=12,!this.config.config["batch.metricsBatching"]){e.next=22;break}if(c=this.config.config["batch.metricsBatchingInterval"],l=null,this.logger.log("Metrics length:",t.length),this.api._storeLock){for(;this._timerTempStore.length>0;)this._timerTempStore.shift().cancel();this.logger.log("Store data in temp store when main store is lock"),l=new Promise(function(e,r){m._promiseTempStore.push({startIndex:m._metricTempStore.length,endIndex:m._metricTempStore.length+t.length,promise:{resolve:e,reject:r},promiseState:"pending"})}),this.logger.log("Add new Promise to temp promiseStore:",n(this._promiseTempStore)),(g=this._metricTempStore).push.apply(g,n(t)),this.logger.log("Batching temp metrics:",this._metricTempStore),this._tempTimer=this.timeout(c,n(this._metricTempStore),r),this.logger.log("Generate temp timer:",this._tempTimer.timer),this._timerTempStore.push(this._tempTimer)}else{for(;this._timerStore.length>0;)this._timerStore.shift().cancel();l=new Promise(function(e,r){m._promiseStore.push({startIndex:m._metricStore.length,endIndex:m._metricStore.length+t.length,promise:{resolve:e,reject:r},promiseState:"pending"})}),this.logger.log("Add new Promise to promiseStore:",n(this._promiseStore)),(u=this._metricStore).push.apply(u,n(t)),this.logger.log("Batching metrics:",this._metricStore),this._timer=this.timeout(c,this._metricStore,r),this.logger.log("Generate timer:",this._timer.timer),this._timerStore.push(this._timer)}return this.logger.log('Calling "trackMetrics" API.'),this.promiseRecursive(),this.logger.log('"trackMetrics" response received:',l),e.abrupt("return",l);case 22:return this.logger.log('Calling "trackMetrics" API.'),e.next=25,this.api.trackMetrics(t,r);case 25:return p=e.sent,this.logger.log('"trackMetrics" response received:',p),e.abrupt("return",p);case 30:throw e.prev=30,e.t0=e.catch(12),e.t0;case 33:case"end":return e.stop()}},e,this,[[12,30]])})),function(e,t){return l.apply(this,arguments)})},{key:"clearTimer",value:function(){this._timer.cancel(),this._timer=null}},{key:"forceTrackMetrics",value:(c=a(h().mark(function e(t){var r,o,i,a,s,c;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==this._metricStore.length){e.next=2;break}return e.abrupt("return");case 2:if(this._promiseStore.some(function(e){return"pending"===e.promiseState})){e.next=4;break}return e.abrupt("return");case 4:for(e.prev=4;this._timerStore.length>0;)this._timerStore.shift().cancel();if(this._timer&&(this._timer=null),this.logger.log('Calling "forceTrackMetrics" API.',n(this._metricStore)),r=null,this.api._storeLock){e.next=13;break}return e.next=12,this.api.trackMetrics(this._metricStore,t);case 12:r=e.sent;case 13:if(this.logger.log('"forceTrackMetrics" response received:',r),this.logger.log('"forceTrackMetrics" resolve promise store',n(this._promiseStore)),!Array.isArray(r)){e.next=30;break}o=r.length,i=0;case 18:if(!(i<this._promiseStore.length)){e.next=26;break}if(!((a=this._promiseStore[i]).endIndex>o)){e.next=22;break}return e.abrupt("break",26);case 22:"pending"===a.promiseState&&(a.promise.resolve(r.slice(a.startIndex,a.endIndex)),a.promiseState="fulfilled");case 23:i++,e.next=18;break;case 26:this._metricStore=[],this._promiseStore=[],this._tempTimer&&(this.logger.log("move temp store to main store"),this._metricStore=this._metricTempStore,this._promiseStore=this._promiseTempStore,this._timerStore=this._timerTempStore,this._timer=this._tempTimer,this._metricTempStore=[],this._promiseTempStore=[],this._timerTempStore=[],this._tempTimer=null,this.promiseRecursive()),this.api._storeLock&&(this.api._storeLock=!1);case 30:return e.abrupt("return");case 33:e.prev=33,e.t0=e.catch(4),s=0;case 36:if(!(s<this._promiseStore.length)){e.next=44;break}if(!((c=this._promiseStore[s]).endIndex>this._metricStore.length)){e.next=40;break}return e.abrupt("break",44);case 40:"pending"===c.promiseState&&(c.promise.reject(e.t0),c.promiseState="rejected");case 41:s++,e.next=36;break;case 44:this._metricStore=[],this._promiseStore=[],this._tempTimer&&(this.logger.log("move temp store to main store"),this._metricStore=this._metricTempStore,this._promiseStore=this._promiseTempStore,this._timerStore=this._timerTempStore,this._timer=this._tempTimer,this._metricTempStore=[],this._promiseTempStore=[],this._timerTempStore=[],this._tempTimer=null,this.promiseRecursive()),this.api._storeLock&&(this.api._storeLock=!1);case 48:case"end":return e.stop()}},e,this,[[4,33]])})),function(e){return c.apply(this,arguments)})},{key:"allocateAndTrack",value:(i=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g,u,p,m=this;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.log('Validating "allocateAndTrack" arguments.'),c=d.validateArguments([{argument:t,name:"userId",type:["number","string"]},{argument:r,name:"projectSlug",type:"string"},{argument:o,name:"testSlug",type:"string"},{argument:n,name:"publicToken",type:"string"},{argument:i,name:"payload",type:["null","undefined","object"]},{argument:a,name:"metrics",type:"array"},{argument:s,name:"headers",type:["object","undefined"]}]),l=c.isArgumentsValid,g=c.argumentsError,l){e.next=4;break}throw g;case 4:return a.forEach(function(e){var t=d.validateArguments([{argument:e.metricSlug,name:"metricSlug",type:"string"},{argument:e.metricValue,name:"metricValue",type:"number"},{argument:e.payload,name:"payload",type:["null","undefined","object"]},{argument:e.eventTime,name:"eventTime",type:["undefined","number"]}]);if(l=t.isArgumentsValid,g=t.argumentsError,!l)throw g}),this.logger.log('All "arguments" are valid.'),a.forEach(function(e,t){e.payload&&(m.logger.log("Generating map from the metrics[".concat(t,"] data object.")),e.userMetadata=d.flattenObject(e.payload),delete e.payload,m.logger.log("Metrics[".concat(t,"] data map is generated:"),e.userMetadata))}),u=null,i&&(this.logger.log("Generating map from the payload data object."),u=d.flattenObject(i),this.logger.log("Payload data map is generated:",u)),e.prev=9,this.logger.log('Calling "allocateAndTrack" API.'),e.next=13,this.api.allocateAndTrack(t,r,o,n,u,a,s);case 13:return(p=e.sent).metaData&&(p.metaData=d.unFlattenObject(p.metaData)),this.logger.log('"allocateAndTrack" response received:',p),e.abrupt("return",p);case 19:throw e.prev=19,e.t0=e.catch(9),e.t0;case 22:case"end":return e.stop()}},e,this,[[9,19]])})),function(e,t,r,o,n,a,s){return i.apply(this,arguments)})},{key:"trigger",value:(o=a(h().mark(function e(t,r,o,n,i,a,s){var c,l,g,u,p;return h().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.log('Validating "trigger" arguments.'),c=d.validateArguments([{argument:t,name:"userId",type:["number","string"]},{argument:r,name:"projectSlug",type:"string"},{argument:o,name:"testSlug",type:"string"},{argument:n,name:"publicToken",type:"string"},{argument:a,name:"payload",type:["null","undefined","object"]},{argument:i,name:"eventTime",type:["undefined","number"]},{argument:s,name:"headers",type:["object","undefined"]}]),l=c.isArgumentsValid,g=c.argumentsError,l){e.next=4;break}throw g;case 4:return this.logger.log('All "arguments" are valid.'),u=null,a&&(this.logger.log("Generating map from the user data object."),u=d.flattenObject(a),this.logger.log("User data map is generated:",u)),this.logger.log('All "arguments" are valid.'),e.prev=8,this.logger.log('Calling "trigger" API.'),e.next=12,this.api.trigger(t,r,o,n,i,u,s);case 12:return p=e.sent,this.logger.log('"trigger" response received:',p),e.abrupt("return",p);case 17:throw e.prev=17,e.t0=e.catch(8),e.t0;case 20:case"end":return e.stop()}},e,this,[[8,17]])})),function(e,t,r,n,i,a,s){return o.apply(this,arguments)})},{key:"allocateAndTrigger",value:(r=a(h().mark(function t(r,o,n,i,a,s,c){var l,g,u,p,m,f;return h().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.logger.log('Validating "allocateAndTrigger" arguments.'),l=d.validateArguments([{argument:r,name:"userId",type:["number","string"]},{argument:o,name:"projectSlug",type:"string"},{argument:n,name:"testSlug",type:"string"},{argument:i,name:"publicToken",type:"string"},{argument:a,name:"payload",type:["null","undefined","object"]},{argument:s,name:"metric",type:["null","undefined","object"]},{argument:c,name:"headers",type:["object","undefined"]}]),g=l.isArgumentsValid,u=l.argumentsError,g){t.next=4;break}throw u;case 4:return"object"===e(s)&&null!==s&&(p=d.validateArguments([{argument:s.eventTime,name:"metricEventTime",type:["undefined","number"]},{argument:s.payload,name:"metricPayload",type:["null","undefined","object"]}]),g=p.isArgumentsValid,u=p.argumentsError),this.logger.log('All "arguments" are valid.'),m=null,a&&(this.logger.log("Generating map from the payload data object."),m=d.flattenObject(a),this.logger.log("Payload data map is generated:",m)),"object"===e(s)&&null!==s&&s.payload&&(this.logger.log("Generating map from the user data object."),s.userMetadata=d.flattenObject(s.payload),delete s.payload,this.logger.log("User data map is generated:",s.userMetadata)),t.prev=9,this.logger.log('Calling "allocateAndTrigger" API.'),t.next=13,this.api.allocateAndTrigger(r,o,n,i,m,s,c);case 13:return(f=t.sent).metaData&&(f.metaData=d.unFlattenObject(f.metaData)),this.logger.log('"allocateAndTrigger" response received:',f),t.abrupt("return",f);case 19:throw t.prev=19,t.t0=t.catch(9),t.t0;case 22:case"end":return t.stop()}},t,this,[[9,19]])})),function(e,t,o,n,i,a,s){return r.apply(this,arguments)})}]),t}()}(),o}()})},{}],27:[function(require,module,exports){"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.set=exports.get=void 0;var _acConsole=require("@marcom/ac-console"),_helpers=require("./helpers");function _regeneratorRuntime(){_regeneratorRuntime=function(){return t};var t={},e=Object.prototype,n=e.hasOwnProperty,r=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function s(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,n){return t[e]=n}}function u(t,e,n,o){var a=e&&e.prototype instanceof p?e:p,i=Object.create(a.prototype),c=new L(o||[]);return r(i,"_invoke",{value:b(t,n,c)}),i}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var l={};function p(){}function h(){}function g(){}var v={};s(v,a,function(){return this});var y=Object.getPrototypeOf,d=y&&y(y(I([])));d&&d!==e&&n.call(d,a)&&(v=d);var m=g.prototype=p.prototype=Object.create(v);function x(t){["next","throw","return"].forEach(function(e){s(t,e,function(t){return this._invoke(e,t)})})}function w(t,e){var o;r(this,"_invoke",{value:function(r,a){function i(){return new e(function(o,i){!function r(o,a,i,c){var s=f(t[o],t,a);if("throw"!==s.type){var u=s.arg,l=u.value;return l&&"object"==_typeof(l)&&n.call(l,"__await")?e.resolve(l.__await).then(function(t){r("next",t,i,c)},function(t){r("throw",t,i,c)}):e.resolve(l).then(function(t){u.value=t,i(u)},function(t){return r("throw",t,i,c)})}c(s.arg)}(r,a,o,i)})}return o=o?o.then(i,i):i()}})}function b(t,e,n){var r="suspendedStart";return function(o,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw a;return E()}for(n.method=o,n.arg=a;;){var i=n.delegate;if(i){var c=_(i,n);if(c){if(c===l)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=f(t,e,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===l)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}function _(t,e){var n=e.method,r=t.iterator[n];if(void 0===r)return e.delegate=null,"throw"===n&&t.iterator.return&&(e.method="return",e.arg=void 0,_(t,e),"throw"===e.method)||"return"!==n&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+n+"' method")),l;var o=f(r,t.iterator,e.arg);if("throw"===o.type)return e.method="throw",e.arg=o.arg,e.delegate=null,l;var a=o.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,l):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,l)}function S(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function k(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(S,this),this.reset(!0)}function I(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function e(){for(;++r<t.length;)if(n.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return h.prototype=g,r(m,"constructor",{value:g,configurable:!0}),r(g,"constructor",{value:h,configurable:!0}),h.displayName=s(g,c,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,g):(t.__proto__=g,s(t,c,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},x(w.prototype),s(w.prototype,i,function(){return this}),t.AsyncIterator=w,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new w(u(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then(function(t){return t.done?t.value:i.next()})},x(m),s(m,c,"Generator"),s(m,a,function(){return this}),s(m,"toString",function(){return"[object Generator]"}),t.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},t.values=I,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(n,r){return i.type="throw",i.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],i=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),s=n.call(a,"finallyLoc");if(c&&s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=t,i.arg=e,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),k(n),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;k(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:I(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,e,n,r,o,a,i){try{var c=t[a](i),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(r,o)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise(function(r,o){var a=t.apply(e,n);function i(t){asyncGeneratorStep(a,r,o,i,c,"next",t)}function c(t){asyncGeneratorStep(a,r,o,i,c,"throw",t)}i(void 0)})}}function getInstanceSettings(){return{constants:{asTexServiceEndpoint:"".concat((0,_helpers.getRootPath)(),"/shop/experience-meta"),origin:window.location.origin,storageName:"as_tex"}}}var parseFetchResponse=function(t){return t&&t.body?t.body.map(function(t){return"".concat(t.activityId,":").concat(t.experienceId,":").concat(t.endDate)}).join("|"):null},fetchCookie=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e,n,r,o;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if((0,_acConsole.log)("ac-okapi : as-tex-management : fetchCookie"),t.prev=1,(e=getInstanceSettings())&&e.constants&&e.constants.origin&&e.constants.asTexServiceEndpoint){t.next=5;break}return t.abrupt("return");case 5:return n="".concat(getInstanceSettings().constants.origin).concat(getInstanceSettings().constants.asTexServiceEndpoint),t.next=8,fetch(n,{});case 8:if((r=t.sent).ok){t.next=11;break}throw Error(r.data);case 11:return t.next=13,r.json();case 13:return o=t.sent,t.abrupt("return",parseFetchResponse(o));case 17:t.prev=17,t.t0=t.catch(1),(0,_acConsole.log)("ac-okapi : as-tex-management : fetch error while getting as_tex",t.t0);case 20:return t.abrupt("return",null);case 21:case"end":return t.stop()}},t,null,[[1,17]])}));return function(){return t.apply(this,arguments)}}(),setCookie=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,n,r){var o,a,i,c,s,u;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if((0,_acConsole.log)("ac-okapi : as-tex-management : setCookie"),(o=getInstanceSettings())&&o.constants&&o.constants.origin&&o.constants.asTexServiceEndpoint){t.next=4;break}return t.abrupt("return");case 4:return a={activityId:e,experienceId:parseInt(n,10),endDate:r},i=Object.keys(a).map(function(t){return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(a[t]))}).join("&"),c="".concat(getInstanceSettings().constants.origin).concat(getInstanceSettings().constants.asTexServiceEndpoint,"?").concat(i),t.prev=7,t.next=10,fetch(c);case 10:return s=t.sent,t.next=13,s.json();case 13:return u=t.sent,t.abrupt("return",parseFetchResponse(u));case 17:t.prev=17,t.t0=t.catch(7);case 19:return t.abrupt("return",null);case 20:case"end":return t.stop()}},t,null,[[7,17]])}));return function(e,n,r){return t.apply(this,arguments)}}(),getCookieInLocalStorage=function(){(0,_acConsole.log)("ac-okapi : as-tex-management : getCookieInLocalStorage");var t=getInstanceSettings();if(t&&t.constants&&t.constants.storageName)return window.localStorage.getItem(getInstanceSettings().constants.storageName)},setCookieInLocalStorage=function(t){(0,_acConsole.log)("ac-okapi : as-tex-management : setCookieInLocalStorage");var e=getInstanceSettings();if(e&&e.constants&&e.constants.storageName){var n=getInstanceSettings().constants.storageName;getCookieInLocalStorage(n)!==t&&(window.localStorage[n]=t)}},get=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function t(){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",getCookieInLocalStorage()||fetchCookie());case 1:case"end":return t.stop()}},t)}));return function(){return t.apply(this,arguments)}}();exports.get=get;var isRequesting=!1,astexQueue=[],set=function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function t(e,n,r){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:!1===isRequesting?(isRequesting=!0,setCookie(e,n,r).then(function(t){if(isRequesting=!1,astexQueue.length){var e=astexQueue.shift();set(e.activityId,e.experienceId,e.endDate)}return setCookieInLocalStorage(t)})):astexQueue.push({activityId:e,experienceId:n,endDate:r});case 1:case"end":return t.stop()}},t)}));return function(e,n,r){return t.apply(this,arguments)}}();exports.set=set},{"./helpers":28,"@marcom/ac-console":1}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.activateTest=activateTest,exports.flagVisitorAsTimeout=flagVisitorAsTimeout,exports.getAllocationSettings=getAllocationSettings,exports.getPayloadData=getPayloadData,exports.getQueryParam=getQueryParam,exports.getRootPath=getRootPath,exports.requestVariations=requestVariations,exports.unmaskContent=unmaskContent;var _acConsole=require("@marcom/ac-console"),_asTexManagement=require("./as-tex-management"),_settings=require("./settings"),_useragentDetect=_interopRequireDefault(require("@marcom/useragent-detect"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,o){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var a=o.call(t,e||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var timeoutExperiments=0,successfulExperiments=0,timeoutSettings=[];function activateTest(t){var e,o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==(e=window)&&void 0!==e&&null!==(o=e.document)&&void 0!==o&&o.body){logCompleteRequest(t,!1);var n=getVariationDetails(t);n&&(window.document.body.setAttribute(n.attrName,n.variation),integrateWithAnalytics(n.testId,n.variation,a,i),(0,_asTexManagement.set)(n.testId,n.variationId,n.endDate),(0,_acConsole.log)("ac-okapi : updateBodyData : ".concat(n.attrName,"=").concat(n.variation," set on body")))}else setTimeout(activateTest.bind(null,t,a,i),20)}function getVariationDetails(t){return t.variation&&t.metaData&&"number"==typeof t.metaData["test-id"]&&"number"==typeof t.metaData["variation-id"]&&"number"==typeof t.metaData["end-date"]?{testId:t.metaData["test-id"],attrName:"data-test-".concat(t.metaData["test-id"]),variationId:t.metaData["variation-id"],endDate:t.metaData["end-date"],variation:t.variation}:void(0,_acConsole.log)("ac-okapi : getVariationDetails : variation details do not match spec")}function requestVariations(t,e,o){window.ac_okapi.okapi.getOrAllocate(getUserId(),t.projectSlug,t.testSlug,t.publicToken,window.ac_okapi.payloadData).then(function(t){e(t[0]),clearTimeout(o)})}function getRootPath(){var t=window.location.pathname.match(/(\/[a-z]{2})\//),e=t&&t.length>1?t[1]:"";return"/us"===e&&(e=""),e}function getCountryCode(t){return t?t.replace("/","").toUpperCase():"US"}function generateId(){return"xxxxxxxx-xxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}function getPayloadData(){return{country:getCountryCode(getRootPath()),uaData:_useragentDetect.default,windowHeight:window.innerHeight,windowWidth:window.innerWidth,userAgent:navigator.userAgent,path:window.location.pathname,as_tex:window.localStorage.as_tex}}function setUserId(t){return window.sessionStorage.okapi=t}function getUserId(){return window.sessionStorage.okapi?window.sessionStorage.okapi:setUserId(generateId())}function getAllocationSettings(){if(window&&window.okapiConfig&&"object"===_typeof(window.okapiConfig)&&"object"===_typeof(window.okapiConfig[0]))return window.okapiConfig}function integrateWithAnalytics(t,e,o,a){var i=successfulExperiments+timeoutExperiments===window.okapiConfig.length;setExperimentData(t,e,o,a);var n=new Event("at-content-rendering-succeeded");i&&(document.dispatchEvent(n),(0,_acConsole.log)("ac-okapi : integrateWithAnalytics : tracking active experiment(s)"))}function setExperimentData(t,e,o,a){a=a?1:0,window.ac_target=window.ac_target||{data:""};var i=window.ac_target.data?" & ":"";window.ac_target.data=window.ac_target.data+="".concat(i).concat(t,":").concat(e,":").concat(o,":r=").concat(a)}function getQueryParam(t){t=t.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(window.location.href);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function unmaskContent(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2500,e=document.querySelectorAll(".okapi-hidden");if(t>=0&&0===e.length)return setTimeout(unmaskContent.bind(null,t-100),100);e.forEach(function(t){t.classList.remove("okapi-hidden")})}function flagVisitorAsTimeout(t){logCompleteRequest(t,!0),(0,_acConsole.log)("ac-okapi : flagVisitorAsTimeout : testSlug:",t.testSlug),integrateWithAnalytics(t.testSlug,"timeout",_settings.okapiConfig.libSettings.customTimeout,!1)}function logCompleteRequest(t,e){e?(timeoutExperiments+=1,timeoutSettings.push(t)):successfulExperiments+=1,timeoutExperiments&&timeoutExperiments+successfulExperiments===window.okapiConfig.length&&setTimeout(updateOkapiStore,500)}function updateOkapiStore(){var t={data:[{variation:"timeout-group"}],expirationTime:"never"};timeoutSettings.forEach(function(e){var o="".concat(getUserId(),"-").concat(e.projectSlug,"-").concat(e.testSlug);if(window.sessionStorage.okapistore){var a=JSON.parse(window.sessionStorage.okapistore);a[o]=t,window.sessionStorage.okapistore=JSON.stringify(a)}else setTimeout(function(){window.sessionStorage.okapistore=JSON.stringify(_defineProperty({},o,t))},1500)}),(0,_acConsole.log)("ac-okapi : flagVisitorAsTimeout : okapistore updated in session storage")}},{"./as-tex-management":27,"./settings":30,"@marcom/ac-console":1,"@marcom/useragent-detect":25}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initializeOkapiClient=initializeOkapiClient,exports.initializeVariant=initializeVariant;var _okapiJsClient=_interopRequireDefault(require("@sse/okapi-js-client")),_acConsole=require("@marcom/ac-console"),_helpers=require("./helpers"),_settings=require("./settings");function _interopRequireDefault(i){return i&&i.__esModule?i:{default:i}}function initializeOkapiClient(i){if(!window)return!1;var e=new _okapiJsClient.default(i);window.ac_okapi=window.ac_okapi||{},window.ac_okapi.okapi=e;var t=(0,_helpers.getPayloadData)();return window.ac_okapi.payloadData=t,(0,_acConsole.log)("ac-okapi : initializeOkapiClient : okapi client initialized"),window.ac_okapi}function initializeVariant(i){return new Promise(function(e,t){var a=setTimeout(function(){t("okapi too slow - aborting"),(0,_helpers.flagVisitorAsTimeout)(i),(0,_acConsole.log)("ac-okapi : initializeVariant : variant timed out (".concat(_settings.okapiConfig.libSettings.customTimeout,"ms)"))},_settings.okapiConfig.libSettings.customTimeout);(0,_helpers.requestVariations)(i,e,a)})}},{"./helpers":28,"./settings":30,"@marcom/ac-console":1,"@sse/okapi-js-client":26}],30:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.okapiConfig=void 0;var prodPath="https://okapi-services.apple.com/api/v3/okapi",devPath="https://okapi-services.apple.com/api/v3/okapi",uatPath="https://okapi-services-uat-usw2.apple.com/api/v3/okapi",uatRegex=/uat=true/,devRegex=/(ic-local|preview).apple.com/,basePath=devRegex.test(window.location.host)?devPath:prodPath;basePath===devPath&&uatRegex.test(window.location.search)&&(basePath=uatPath);var okapiConfig={cache:{duration:"SESSION",size:100},endpoints:{basePath:basePath,getOrAllocatePath:"/getOrAllocate",forceAllocatePath:"/forceAllocate",trackMetricsPath:"/track",allocateAndTrackPath:"/allocateAndTrack",triggerPath:"/trigger",allocateAndTriggerPath:"/allocateAndTrigger",timeout:5e3,retries:0,retryDelay:3e3},libSettings:{customTimeout:window.okapiCustomTimeout||1e3}};exports.okapiConfig=okapiConfig},{}],"@marcom/ac-okapi":[function(require,module,exports){"use strict";var _initializeOkapi=require("./initialize-okapi"),_helpers=require("./helpers"),_settings=require("./settings"),_log=_interopRequireDefault(require("@marcom/ac-console/src/log"));function _interopRequireDefault(i){return i&&i.__esModule?i:{default:i}}try{var initTime=performance.now(),okapi=(0,_initializeOkapi.initializeOkapiClient)(_settings.okapiConfig),allocationSettings=(0,_helpers.getAllocationSettings)();okapi&&allocationSettings?allocationSettings.forEach(function(i){var e,t,a,o=(null===(e=window)||void 0===e?void 0:null===(t=e.sessionStorage)||void 0===t?void 0:null===(a=t.okapistore)||void 0===a?void 0:a.indexOf(i.testSlug))>=0;(0,_initializeOkapi.initializeVariant)(i).then(function(e){(0,_log.default)("ac-okapi : Variation successfully requested, activating test:",i.testSlug);var t=performance.now(),a=parseInt(t-initTime);e.metaData&&e.metaData["test-id"]&&(0,_helpers.activateTest)(e,a,o),(0,_helpers.unmaskContent)()},function(i){(0,_helpers.unmaskContent)(),(0,_log.default)("ac-okapi : Failed to request variant. Response:",i)})}):(0,_log.default)("ac-okapi : getAllocationSettings : Okapi Config Not Found or Not Correct")}catch(i){(0,_log.default)("ac-okapi error : ",i)}},{"./helpers":28,"./initialize-okapi":29,"./settings":30,"@marcom/ac-console/src/log":14}]},{},["@marcom/ac-okapi"]);
(()=>{"use strict";let e;class t{constructor(e,t,s,n){this.options={templateId:"breaking-news-alert",hostname:"",secure:!0,port:443,showFilters:new Array},this.socketQuery={},this.storage={set:(e,t)=>{window.sessionStorage?window.sessionStorage.setItem(e,t):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[e]=t)},get:e=>window.sessionStorage?sessionStorage.getItem(e):(window.breakingNews.storage=window.breakingNews.storage||{},window.breakingNews.storage[e]||void 0)},this.socketQuery=s,this.options=Object.assign(this.options,e),this.templateId=this.options.templateId;let o=document.createElement("div");o.classList.add("breaking-news-container"),this.container=o,document.body.appendChild(this.container),window.localStorage&&window.localStorage.setItem("ns.authToken",t),this.connect(n)}add(e){return this.container.innerHTML=tmpl(this.templateId,e),this}canShow(e){let t=this.options.showFilters;ExpressApp.Log("[BREAKING NEWS] canShow");let s=!t.length||!0;return t.forEach((t=>{s=s&&t(e)})),ExpressApp.Log("[BREAKING NEWS] Can"+(s?" ":"'t ")+"show"),s}connect(e){ExpressApp.Log("[BREAKING NEWS] connect successfully, subscribing"),this.socket=window.socketCluster.connect({path:"/ns/",hostname:this.options.hostname,secure:this.options.secure,port:this.options.port,authTokenName:"ns.authToken",query:this.socketQuery||{}}),this.socket.on("error",(e=>{ExpressApp.Log("[BREAKING NEWS] Socket error - "+e)})),this.socket.on("connect",function(){ExpressApp.Log("[BREAKING NEWS] CONNECTED"),this.subscribe("site-wide"),"function"==typeof e&&e.apply(this)}.bind(this))}remove(){return this.container.querySelector(".breaking-news").remove(),this}hide(){const e=this.container.querySelector(".breaking-news");return e.classList.add("off"),e.classList.remove("on"),this}on(t,s){e.hasOwnProperty(t)||(e[t]=[]),e[t].push(s)}wasShown(e){let t=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[],s=!1;if(ExpressApp.Log("[BREAKING NEWS] breaking wasShown",t),Array.isArray(t))for(let n=0,o=t.length;n<o;n++){let o=t[n];e.sectionId===o.sectionId&&e.headline===o.headline&&e.url===o.url&&(s=!0)}return ExpressApp.Log("[BREAKING NEWS] Was"+(s?"":" not")+" shown"),s}show(e){const t=this.container.querySelector(".breaking-news");return t.classList.remove("off"),t.classList.add("on"),ExpressApp.GoogleAnalytics.TrackCustomEvent("breakingnews","view",e.sectionCategory,e.articleId),this}subscribe(e,t){let s=function(e,t){return function(t){if(ExpressApp.Log("[BREAKING NEWS]["+e+"] response: ",t),!this.wasShown(t)&&this.canShow(t)){this.add(t).show(t);let e=function(){this.hide(t);let e=JSON.parse(this.storage.get("breaking-news-shown-notifications"))||[];Array.isArray(e)||(e=[]),e.push(t),this.storage.set("breaking-news-shown-notifications",JSON.stringify(e)),document.querySelector(".breaking-news-wrapper").remove()}.bind(this);this.container.querySelector(".breaking-news .breaking-news-headline").addEventListener("click",(s=>{s.preventDefault(),e(),ExpressApp.GoogleAnalytics.TrackCustomEvent("breakingnews","click",t.sectionCategory,t.articleId);const n=s.target.getAttribute("href");setTimeout((function(){window.location.assign(n)}),100)})),this.container.querySelector(".breaking-news .breaking-news-header-close-btn").addEventListener("click",(()=>{e(),ExpressApp.GoogleAnalytics.TrackCustomEvent("breakingnews","close",t.sectionCategory,t.articleId)}))}}.bind(t)}(e,this);this.socket.subscribe(e).watch(t||s),this.socket.on(e,function(e,n){ExpressApp.Log("[BREAKING NEWS] Personal message received for this socket",e),(t||s)(e),n(null,"Success")}.bind(this))}}const s=()=>{const e=new t({hostname:breakingNewsData.hostname,secure:breakingNewsData.secure,port:breakingNewsData.port,showFilters:[function(e){let t=window.utag_data.article?window.utag_data.article.id:0;return e.articleId!=t}]},breakingNewsData.JWT,{section:breakingNewsData.observedSections,prefix:breakingNewsData.prefix},(function(){document.getElementById("div-gpt-ad-sticky-bottom-banner")&&e.container.classList.add("with-mobile-floating-ad");for(let e=0;e<breakingNewsData.observedSections.length;e++)this.subscribe("section-"+breakingNewsData.observedSections[e]);this.socket.emit("ready",(function(e,t){e?ExpressApp.Log("[BREAKING NEWS] [ready] error",e):ExpressApp.Log("[BREAKING NEWS] [ready] response",t)}))}))};let n=!1,o=!1;document.addEventListener("tcfLoaded",(()=>{n=!0,ExpressApp.Log("[tcfLoaded] BreakingNews"),o&&s()})),"undefined"!=typeof flagTcfLoaded&&flagTcfLoaded&&(n=!0,ExpressApp.Log("[tcfLoaded] BreakingNews flag"),o&&s()),document.addEventListener("DOMContentLoaded",(()=>{o=!0,n&&s()}))})();
(()=>{"use strict";const t=window.bookmarksEndpoint,e="express",o=()=>JSON.parse(localStorage.getItem("auth-user")).Uid||null,a=t=>Math.floor(t/1e3),n=t=>{window.localStorage.setItem("bookmarks",JSON.stringify(t)),window.localStorage.setItem("lastBookmarkUpdate",Date.now().toString())};let r=[];const i=()=>{return r=void 0,i=void 0,l=function*(){if(!(()=>{if(window.localStorage.getItem("bookmarks")){const t=a(parseFloat(window.localStorage.getItem("lastBookmarkUpdate")))||0;return a(Date.now())-t>1800}return!0})())return(()=>{let t=[];try{t=JSON.parse(window.localStorage.getItem("bookmarks"))}catch(t){ExpressApp.Log("[Bookmark] getLocalBookmarks",t)}return t})();try{const a=yield(r=void 0,i=void 0,c=void 0,l=function*(){return fetch(`${t}/api/bookmarks`,{headers:{publication:e,uid:o(),"Content-Type":"application/json"}}).then((t=>t.json())).then((t=>t)).catch((t=>{ExpressApp.Log("[Bookmark] getBookmarks",t)}))},new(c||(c=Promise))((function(t,e){function o(t){try{n(l.next(t))}catch(t){e(t)}}function a(t){try{n(l.throw(t))}catch(t){e(t)}}function n(e){var n;e.done?t(e.value):(n=e.value,n instanceof c?n:new c((function(t){t(n)}))).then(o,a)}n((l=l.apply(r,i||[])).next())})));return n(a),a}catch(t){ExpressApp.Log("[Bookmark] DataGet",t)}var r,i,c,l},new((c=void 0)||(c=Promise))((function(t,e){function o(t){try{n(l.next(t))}catch(t){e(t)}}function a(t){try{n(l.throw(t))}catch(t){e(t)}}function n(e){var n;e.done?t(e.value):(n=e.value,n instanceof c?n:new c((function(t){t(n)}))).then(o,a)}n((l=l.apply(r,i||[])).next())}));var r,i,c,l},c=t=>(r=t,n(r),r),l=()=>{for(let t of document.querySelectorAll("[data-bookmark-popup]"))t.remove()};let d=[];const s=t=>{t.preventDefault(),k(t.currentTarget)},u=t=>{t.preventDefault(),m(t.currentTarget)},k=a=>{const n={articleId:a.getAttribute("data-article-id"),articlePublisher:"express",bookmarkingPublication:"express",headline:a.getAttribute("data-article-headline"),articleUrl:a.getAttribute("data-article-url"),imageUrl:a.getAttribute("data-article-image")};var r;d.find((t=>t.articleId===n.articleId))||(d=c([...d,n])),r=n,fetch(`${t}/api/addBookmark`,{method:"POST",headers:{publication:e,uid:o(),"Content-Type":"application/json"},body:JSON.stringify(r)}).then((t=>t.json())).then((t=>t)).catch((t=>{ExpressApp.Log("[Bookmark] addBookmark",t)})),(t=>{const e=document.createDocumentFragment(),o=document.createElement("div");o.setAttribute("class","delete-bookmark-popup"),o.setAttribute("data-bookmark-popup",""),o.innerHTML=t,e.appendChild(o),document.body.appendChild(e),setTimeout((()=>{l()}),5e3)})('<div class="modal">\n                    <h3>\n                        <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M6.00016 11.1698L1.83016 6.99984L0.410156 8.40984L6.00016 13.9998L18.0002 1.99984L16.5902 0.589844L6.00016 11.1698Z" fill="#D8021E"></path>\n                        </svg>\n                        Story Saved\n                    </h3>\n                    <p>You can find this in <a href="/my-bookmarks" title="My Bookmarks">My Bookmarks</a>.</p>\n                    <p>Or by navigating to the username in the top right.</p>\n                </div>'),p(a),h(a)},m=a=>{const n=a.getAttribute("data-article-id");d=c(d.filter((t=>t.articleId!==n))),(a=>{fetch(`${t}/api/removeBookmark`,{method:"DELETE",headers:{publication:e,uid:o(),"Content-Type":"application/json"},body:JSON.stringify({articleId:a})}).then((t=>t.json())).then((t=>t)).catch((t=>{ExpressApp.Log("[Bookmark] deleteBookmark",t)}))})(n),f(a),f(a),v(a)},p=t=>{if(t instanceof HTMLElement){t.dataset.bookmark="1";const e=t.querySelector("[data-bookmark-text]");e&&(e.textContent="Saved")}},f=t=>{if(t instanceof HTMLElement){t.dataset.bookmark="0";const e=t.querySelector("[data-bookmark-text]");e&&(e.textContent="Bookmark")}},v=t=>{t.removeEventListener("click",u),t.removeEventListener("click",s),t.addEventListener("click",s)},h=t=>{t.removeEventListener("click",s),t.removeEventListener("click",u),t.addEventListener("click",u)};let g=!1,w=!1;const b=()=>{return t=void 0,e=void 0,a=function*(){(t=>{d=t;for(let t of document.querySelectorAll("[data-bookmark]"))if(t instanceof HTMLElement){const e=t.getAttribute("data-article-id");if(t.dataset.show="1",d.find((t=>t.articleId===e))){t.dataset.bookmark="1";const e=t.querySelector("[data-bookmark-text]");e&&(e.textContent="Saved")}}})(yield i());for(let t of document.querySelectorAll('[data-bookmark="0"]'))v(t);for(let t of document.querySelectorAll('[data-bookmark="1"]'))h(t);S()},new((o=void 0)||(o=Promise))((function(n,r){function i(t){try{l(a.next(t))}catch(t){r(t)}}function c(t){try{l(a.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,c)}l((a=a.apply(t,e||[])).next())}));var t,e,o,a},y=t=>{t.preventDefault();const e=t.currentTarget;window.localStorage.setItem("bookmarksToSave",e.getAttribute("data-article-url")),window.dispatchEvent(new CustomEvent("auth-ui.authenticate",{detail:{origin:"header"}}))},S=()=>{const t=window.localStorage.getItem("bookmarksToSave");t&&(document.querySelector(`[data-article-url="${t}"]`).click(),window.localStorage.removeItem("bookmarksToSave"))};window.addEventListener("DOMContentLoaded",(()=>{window.addEventListener("auth-ui.authentication",(t=>{if(!1===g)if(t&&t.detail&&t.detail.user){w=!0;for(let t of document.querySelectorAll('[data-bookmark="0"]'))t.removeEventListener("click",y);b()}else for(let t of document.querySelectorAll('[data-bookmark="0"]'))t instanceof HTMLElement&&(t.dataset.show="1",t.addEventListener("click",y));if(!0===g&&!1===w){for(let t of document.querySelectorAll('[data-bookmark="0"]'))t.removeEventListener("click",y);b()}g=!0}))}))})();